<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Hexa Solar - Calculadora Inteligente</title>
  <link rel="icon" type="image/png" href="img/logo.png">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <link rel="stylesheet" href="styles.css">
  <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>

  <!-- üîß Split bar (empieza a la mitad y permite pasarla) + consumo responsivo -->
  <style>
    /* ---------- Split layout ---------- */
    .main-container {
      display: flex;
      width: 100%;
      min-height: calc(100vh - 64px);
      overflow: hidden;
    }

    .form-panel {
      flex: 0 0 50%;
      width: 50%;
      min-width: 320px;
      overflow: auto;
    }

    .results-panel {
      flex: 1 1 auto;
      min-width: 320px;
      overflow: auto;
    }

    .resizer {
      flex: 0 0 8px;
      width: 8px;
      background: linear-gradient(90deg, #eef8f3, #d7efe3);
      box-shadow: inset 0 0 0 1px rgba(0, 0, 0, .06);
      cursor: col-resize;
      align-self: stretch;
      touch-action: none;
      position: relative;
      z-index: 10;
    }

    .resizer::after {
      content: "";
      position: absolute;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%);
      width: 3px;
      height: 44px;
      border-radius: 2px;
      background: rgba(30, 146, 75, .7);
    }

    .resizer.is-dragging {
      background: #cfeadc;
    }

    body.is-resizing {
      cursor: col-resize;
      user-select: none;
    }

    /* ---------- Consumo: inputs id√©nticos al resto y 100% responsivo ---------- */
    .consumo-panel {
      background: #fff;
      border: 1px solid #e2e8f0;
      border-radius: 12px;
      padding: 1rem 1rem 1.2rem;
    }

    .consumo-row {
      margin-top: .9rem;
    }

    .consumo-row-label {
      font-weight: 600;
      color: #2d3748;
      font-size: .95rem;
      margin-bottom: .55rem;
    }

    .consumo-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: .8rem 1rem;
    }

    @media (max-width: 1200px) {
      .consumo-grid {
        grid-template-columns: repeat(auto-fit, minmax(170px, 1fr));
      }
    }

    @media (max-width: 900px) {
      .consumo-grid {
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      }
    }

    @media (max-width: 640px) {
      .consumo-grid {
        grid-template-columns: repeat(auto-fit, minmax(130px, 1fr));
      }
    }

    .consumo-input {
      width: 100%;
      background: #fff;
      border: 1px solid #cbd5e1;
      border-radius: 8px;
      padding: 5px 7px;
      font-size: .87rem;
      color: #1a202c;
      text-align: center;
    }

    .consumo-input:focus {
      outline: none;
      border-color: #73b248;
      box-shadow: 0 0 0 3px rgba(115, 178, 72, 0.10);
    }
  </style>
</head>

<body>
  <!-- Barra superior -->
  <div class="top-bar">
    <div class="logo">
      <img src="img/logo.png" alt="Hexa Solar Logo" class="logo-image"
        onerror="this.style.display='none'; this.nextElementSibling.style.display='inline';">
      <i class="fas fa-solar-panel" style="display: none;"></i>
      <span>Hexa Solar Power Solution</span>
    </div>
    <div class="contact-info">
      <div class="contact-item">
        <i class="fas fa-map-marker-alt"></i>
        <span>Canc√∫n | Playa del Carmen | Tulum</span>
      </div>
      <div class="contact-item">
        <i class="fas fa-phone-alt"></i>
        <span>984 231 2287</span>
      </div>
      <div class="contact-item">
        <i class="fas fa-globe"></i>
        <a href="https://hexasolar.com.mx" class="contact-link" target="_blank">hexasolar.com.mx</a>
      </div>
    </div>
  </div>

  <!-- Contenedor principal -->
  <div class="main-container">
    <!-- Panel izquierdo - Formulario -->
    <div class="form-panel">
      <!-- Datos del Cliente -->
      <div class="form-section">
        <div class="section-title">
          <i class="fas fa-user"></i>
          <span>Datos del Cliente</span>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label for="nombreCliente">Nombre</label>
            <input type="text" id="nombreCliente" placeholder="Nombre completo"
              style="width:100%; background:#fff; border:1px solid #cbd5e1; border-radius:8px; padding:5px 7px; font-size:0.87rem; color:#1a202c;">
          </div>
          <div class="form-group">
            <label for="direccionCliente">Direcci√≥n</label>
            <input type="text" id="direccionCliente" placeholder="Calle, n√∫mero, colonia, municipio y estado"
              style="width:100%; background:#fff; border:1px solid #cbd5e1; border-radius:8px; padding:5px 7px; font-size:0.87rem; color:#1a202c;">
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label for="telefonoCliente">Tel√©fono</label>
            <input type="text" id="telefonoCliente" placeholder="Tel√©fono"
              style="width:100%; background:#fff; border:1px solid #cbd5e1; border-radius:8px; padding:5px 7px; font-size:0.87rem; color:#1a202c;">
          </div>
          <div class="form-group">
            <label for="correoCliente">Correo</label>
            <input type="email" id="correoCliente" placeholder="Correo electr√≥nico"
              style="width:100%; background:#fff; border:1px solid #cbd5e1; border-radius:8px; padding:5px 7px; font-size:0.87rem; color:#1a202c;">
          </div>
        </div>
      </div>

      <!-- Datos del Ejecutivo -->
      <div class="form-section">
        <div class="section-title">
          <i class="fas fa-user-tie"></i>
          <span>Datos del Ejecutivo</span>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label for="nombreEjecutivo">Nombre del Ejecutivo</label>
            <input type="text" id="nombreEjecutivo" placeholder="Nombre del ejecutivo"
              style="width:100%; background:#fff; border:1px solid #cbd5e1; border-radius:8px; padding:5px 7px; font-size:0.87rem; color:#1a202c;">
          </div>
          <div class="form-group">
            <label for="correoEjecutivo">Correo Electr√≥nico</label>
            <input type="email" id="correoEjecutivo" placeholder="ejecutivo@empresa.com"
              style="width:100%; background:#fff; border:1px solid #cbd5e1; border-radius:8px; padding:5px 7px; font-size:0.87rem; color:#1a202c;">
          </div>
          <div class="form-group">
            <label for="folioCotizacion">Folio de Cotizaci√≥n</label>
            <input type="text" id="folioCotizacion" placeholder="Folio de cotizaci√≥n"
              style="width:100%; background:#fff; border:1px solid #cbd5e1; border-radius:8px; padding:5px 7px; font-size:0.87rem; color:#1a202c;">
          </div>
        </div>
      </div>

      <!-- Datos del Proyecto -->
      <div class="form-section">
        <div class="section-title">
          <i class="fas fa-project-diagram"></i>
          <span>Datos del Proyecto</span>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label for="tipoProyecto">Tipo de Proyecto</label>
            <select id="tipoProyecto"
              style="width:100%; background:#fff; border:1px solid #cbd5e1; border-radius:8px; padding:5px 7px; font-size:0.87rem; color:#1a202c;">
              <option value="">Seleccionar tipo</option>
              <option value="residencial">Residencial</option>
              <option value="comercial">Comercial</option>
              <option value="industrial">Industrial</option>
            </select>
          </div>
          <div class="form-group">
            <label for="tipoTarifa">Tipo de Tarifa</label>
            <select id="tipoTarifa"
              style="width:100%; background:#fff; border:1px solid #cbd5e1; border-radius:8px; padding:5px 7px; font-size:0.87rem; color:#1a202c;">
              <option value="">Selecciona una tarifa</option>
            </select>
          </div>
        </div>

        <!-- Nota + Estado -->
        <div class="form-row">
          <div class="form-group">
            <label for="notaProyecto">Nota</label>
            <input type="text" id="notaProyecto" placeholder="Nota del proyecto"
              style="width:100%; background:#fff; border:1px solid #cbd5e1; border-radius:8px; padding:5px 7px; font-size:0.87rem; color:#1a202c;">
          </div>
          <div class="form-group">
            <label for="estadoProyecto">Estado</label>
            <select id="estadoProyecto"
              style="width:100%; background:#fff; border:1px solid #cbd5e1; border-radius:8px; padding:5px 7px; font-size:0.87rem; color:#1a202c;">
              <option value="">Selecciona un estado</option>
              <option value="Aguascalientes">Aguascalientes</option>
              <option value="Baja California">Baja California</option>
              <option value="Baja California Sur">Baja California Sur</option>
              <option value="Campeche">Campeche</option>
              <option value="Chiapas">Chiapas</option>
              <option value="Chihuahua">Chihuahua</option>
              <option value="Ciudad de M√©xico">Ciudad de M√©xico</option>
              <option value="Coahuila">Coahuila</option>
              <option value="Colima">Colima</option>
              <option value="Durango">Durango</option>
              <option value="Estado de M√©xico">Estado de M√©xico</option>
              <option value="Guanajuato">Guanajuato</option>
              <option value="Guerrero">Guerrero</option>
              <option value="Hidalgo">Hidalgo</option>
              <option value="Jalisco">Jalisco</option>
              <option value="Michoac√°n">Michoac√°n</option>
              <option value="Morelos">Morelos</option>
              <option value="Nayarit">Nayarit</option>
              <option value="Nuevo Le√≥n">Nuevo Le√≥n</option>
              <option value="Oaxaca">Oaxaca</option>
              <option value="Puebla">Puebla</option>
              <option value="Quer√©taro">Quer√©taro</option>
              <option value="Quintana Roo">Quintana Roo</option>
              <option value="San Luis Potos√≠">San Luis Potos√≠</option>
              <option value="Sinaloa">Sinaloa</option>
              <option value="Sonora">Sonora</option>
              <option value="Tabasco">Tabasco</option>
              <option value="Tamaulipas">Tamaulipas</option>
              <option value="Tlaxcala">Tlaxcala</option>
              <option value="Veracruz">Veracruz</option>
              <option value="Yucat√°n">Yucat√°n</option>
              <option value="Zacatecas">Zacatecas</option>
            </select>
          </div>
        </div>

        <!-- NUEVO: Municipio/Ciudad + Regi√≥n tarifaria CFE (auto) -->
        <div class="form-row">
          <div class="form-group">
            <label for="municipioProyecto">Municipio / Ciudad</label>
            <input type="text" id="municipioProyecto" placeholder="Ciudad o Municipio"
              style="width:100%; background:#fff; border:1px solid #cbd5e1; border-radius:8px; padding:5px 7px; font-size:0.87rem; color:#1a202c;">
          </div>
          <div class="form-group">
            <label for="regionTarifariaCFE">Regi√≥n tarifaria CFE</label>
            <input type="text" id="regionTarifariaCFE" placeholder="Se llena autom√°ticamente" readonly
              style="width:100%; background:#fff; border:1px solid #cbd5e1; border-radius:8px; padding:5px 7px; font-size:0.87rem; color:#1a202c;">
          </div>
        </div>

        <div class="form-row">
          <div class="form-group" style="grid-column: span 2;">
            <label for="requerimientosProyecto">Requerimientos</label>
            <input type="text" id="requerimientosProyecto" placeholder="Requerimientos del proyecto"
              style="width:100%; background:#fff; border:1px solid #cbd5e1; border-radius:8px; padding:5px 7px; font-size:0.87rem; color:#1a202c;">
          </div>
        </div>

        <!-- Consumo -->
        <div class="section-title" style="margin-top:24px;">
          <i class="fas fa-chart-line"></i>
          <span>Datos de Consumo Energ√©tico</span>
        </div>

        <div class="form-row" style="margin-bottom: 1rem;">
          <div class="form-group">
            <label for="tipoPeriodo">Per√≠odo de Facturaci√≥n</label>
            <select id="tipoPeriodo" onchange="generarInputsConsumo()"
              style="width:100%; background:#fff; border:1px solid #cbd5e1; border-radius:8px; padding:5px 7px; font-size:0.87rem; color:#1a202c;">
              <option value="bimestral">Bimestral (6 valores)</option>
              <option value="mensual">Mensual (12 valores)</option>
            </select>
          </div>
        </div>

        <!-- Panel consumo responsivo -->
        <div id="consumoContainer" class="consumo-panel">
          <!-- Nota -->

          <div class="form-row">
            <div class="form-group" style="grid-column: span 2;">
              <label>Consumo Hist√≥rico (kWh)</label>
              <div id="kwhRow" class="consumo-grid"></div>
            </div>
          </div>
          <div style="
  margin:16px 0; 
  padding:6px 12px; 
  border-left:4px solid #16a34a; 
  background:#ecfdf5; 
  border-radius:4px; 
  font-size:0.7rem; 
  color:#065f46; 
  line-height:1.4;
">
            <i class="fas fa-info-circle" style="margin-right:6px; color:#16a34a;"></i>
            Nota: Puede llenar <strong>Pagos por per√≠odo</strong> o <strong>Tarifas promedio</strong>, cualquiera de los
            dos funciona.
            <br>
            <i style="margin-left:20px;">Si ingresa uno, el otro se autocompletar√° autom√°ticamente.</i>
          </div>


          <div class="form-row">
            <div class="form-group" style="grid-column: span 2;">
              <label>Pagos por Per√≠odo ($)</label>
              <div id="pagoRow" class="consumo-grid"></div>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group" style="grid-column: span 2;">
              <label>Tarifa Promedio ($/kWh)</label>
              <div id="tarifaRow" class="consumo-grid"></div>
            </div>
          </div>
        </div>
        <!-- /panel consumo -->
      </div>

      <!-- Especificaciones del panel -->
      <div class="form-section">
        <div class="section-title" style="margin-bottom:1.2rem;">
          <i class="fas fa-drafting-compass"></i>
          <span>Dise√±o y dimensionamiento</span>
        </div>

        <div class="panel-spec-grid">
          <div>
            <div class="panel-spec-row">
              <div class="form-group" style="flex:1;">
                <label for="potenciaPanel">Potencia Panel</label>
                <input type="number" id="potenciaPanel" placeholder="">
              </div>
            </div>
            <div class="panel-spec-row">
              <div class="form-group" style="flex:1;">
                <label for="marcaPanel">Marca</label>
                <input type="text" id="marcaPanel" placeholder="">
              </div>
            </div>
            <div class="panel-spec-row">
              <div class="form-group" style="flex:1;">
                <label for="modeloPanel">Modelo</label>
                <input type="text" id="modeloPanel" placeholder="">
              </div>
            </div>
            <hr class="panel-divider">
            <div class="panel-spec-row">
              <div class="form-group" style="flex:1;">
                <label for="inversorPanel">Inversor</label>
                <select id="inversorPanel"
                  style="width:100%; background:#fff; border:1px solid #cbd5e1; border-radius:8px; padding:5px 7px; font-size:0.87rem; color:#1a202c;">
                  <option value="">Seleccione</option>
                  <option value="Microinversor">Microinversor</option>
                  <option value="Central">Central</option>
                </select>
              </div>
            </div>
            <div class="panel-spec-row">
              <div class="form-group" style="flex:1;">
                <label for="potenciaInversor">Potencia</label>
                <input type="number" id="potenciaInversor" placeholder="">
              </div>
            </div>
          </div>
          <div>
            <div class="panel-spec-row">
              <div class="form-group" style="flex:1;">
                <label for="instalacionElectrica">Instalaci√≥n el√©ctrica</label>
                <select id="instalacionElectrica"
                  style="width:100%; background:#fff; border:1px solid #cbd5e1; border-radius:8px; padding:5px 7px; font-size:0.87rem; color:#1a202c;">
                  <option value="">Seleccione</option>
                  <option value="bif">Bifasica</option>
                  <option value="monof">Monofasica</option>
                  <option value="tet">Trifasica</option>
                </select>
              </div>
            </div>
            <div class="panel-spec-row">
              <div class="form-group" style="flex:1;">
                <label for="numHilos"># de hilos</label>
                <select id="numHilos"
                  style="width:100%; background:#fff; border:1px solid #cbd5e1; border-radius:8px; padding:5px 7px; font-size:0.87rem; color:#1a202c;">
                  <option value="">Seleccione</option>
                  <option value="1">1</option>
                  <option value="2">2</option>
                  <option value="3">3</option>
                  <option value="4">4</option>
                  <option value="5">5</option>
                  <option value="6">6</option>
                </select>
              </div>
            </div>
            <div class="panel-spec-row">
              <div class="form-group" style="flex:1;">
                <label for="voltajeOperacion">Voltaje oper.</label>
                <select id="voltajeOperacion"
                  style="width:100%; background:#fff; border:1px solid #cbd5e1; border-radius:8px; padding:5px 7px; font-size:0.87rem; color:#1a202c;">
                  <option value="">Seleccione</option>
                  <option value="220">220</option>
                  <option value="440">440</option>
                  <option value="480">480</option>
                </select>
              </div>
            </div>
            <hr class="panel-divider">
            <div class="panel-spec-row">
              <div class="form-group" style="flex:1;">
                <label for="areaAprox">√Årea aproximada</label>
                <input type="number" id="areaAprox" placeholder="">
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Cotizaci√≥n P.U. -->
      <div class="form-section" style="margin-top:2.2rem; margin-bottom:1.5rem;">
        <div class="section-title" style="margin-bottom:1.2rem;">
          <i class="fas fa-file-invoice-dollar"></i>
          <span>Cotizaci√≥n P.U.</span>
        </div>
        <div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:1.2rem 2.2rem; margin-bottom:1.1rem;">
          <div>
            <div class="form-group"><label for="panel" style="font-weight:500;">Panel:</label><input id="panel"
                style="width:100%;" type="text"></div>
            <div class="form-group"><label for="inversor" style="font-weight:500;">Inversor:</label><input id="inversor"
                style="width:100%;" type="text"></div>
            <div class="form-group"><label for="mantenimiento" style="font-weight:500;">Monitoreo:</label><input
                type="text" id="monitoreo" style="width:100%;"></div>
            <div class="form-group"><label for="estructura" style="font-weight:500;">Estructura:</label><input
                type="text" id="estructura" style="width:100%;"></div>
            <div class="form-group"><label for="materiales" style="font-weight:500;">Materiales:</label><input
                type="text" id="materiales" style="width:100%;"></div>
          </div>
          <div>
            <div class="form-group"><label for="instalacion" style="font-weight:500;">Instalaci√≥n:</label><input
                type="text" id="instalacion" style="width:100%;"></div>
            <div class="form-group"><label for="carpeta" style="font-weight:500;">Carpeta de proyecto:</label><input
                type="text" id="carpeta" style="width:100%;"></div>
            <div class="form-group"><label for="flete" style="font-weight:500;">Flete:</label><input id="flete"
                style="width:100%;" type="text"></div>
            <div class="form-group"><label for="interconexion" style="font-weight:500;">Interconexi√≥n:</label><input
                type="text" id="interconexion" style="width:100%;"></div>
            <div class="form-group"><label for="uve" style="font-weight:500;">UVIE:</label><input id="uve" id="uve"
                style="width:100%;" type="text"></div>
          </div>
          <div>
            <div class="form-group"><label for="uie" style="font-weight:500;">UIE:</label><input id="uie" id="uie"
                style="width:100%;" type="text"></div>
            <div class="form-group"><label for="medidor" style="font-weight:500;">Medidor:</label><input id="medidor"
                style="width:100%;" type="text"></div>
            <div class="form-group"><label for="profit" style="font-weight:500;">Profit (%):</label><input type="number"
                id="profit" type="text" style="width:100%;"></div>
            <hr style="margin:1.1rem 0; border:none; border-top:1px solid #e2e8f0;">
            <div class="form-group"><label for="total" style="font-weight:500;">Total (MXN):</label><input type="text"
                id="total" style="width:100%;"></div>
          </div>
        </div>
      </div>

      <script>

        ; (() => {
          const IVA_RATE = 0.16
          const IDS_COSTOS = [
            ['panel', 'Panel'],
            ['inversor', 'Inversor'],
            ['materiales', 'Materiales'],   // <-- corregido
            ['estructura', 'Estructura'],
            ['instalacion', 'Instalaci√≥n'],
            ['carpeta', 'Carpeta (Pog)'],
            ['flete', 'Flete'],
            ['interconexion', 'Interconexi√≥n'],
            ['uve', 'UVIE'],
            ['uie', 'UIE'],
            ['medidor', 'Medidor'],
            ['monitoreo','Monitoreo']
          ]

          let resultados = {}
          const data = localStorage.getItem("resultadosSistemaSolar")
          if (data) {
            resultados = JSON.parse(data)
            console.log(resultados)
          }

          // Valor declarado por ti:
          const inversorOmicro = resultados ? resultados.selectInversor : null // "Microinversor" o algo m√°s
          console.log('Inversor o micro:', inversorOmicro)
          const $ = (id) => document.getElementById(id)
          const toNumber = (v) => {
            if (v === null || v === undefined) return 0
            const s = String(v).replace(/[,$\s]/g, '').replace(',', '.')
            const n = parseFloat(s)
            return isNaN(n) ? 0 : n
          }
          const fmt = (n) => n.toLocaleString('es-MX', { style: 'currency', currency: 'MXN', maximumFractionDigits: 2 })

          const getPotenciaW = () => {
            const el = $('potenciaInstalada')
            if (!el) return null
            const kw = toNumber(el.textContent)
            return kw > 0 ? kw * 1000 : null
          }

          const getNumeroDeModulos = () => {
            // Prioriza lo calculado y guardado:
            if (resultados && Number(resultados.numeroModulos) > 0) return Number(resultados.numeroModulos)
            const el = $('numeroModulos')
            if (!el) return null
            const num = toNumber(el.textContent)
            return num > 0 ? num : null
          }

          const calcularProfit = (subtotal) => {
            const raw = $('profit')?.value
            const p = toNumber(raw)
            if (!p) return { monto: 0, etiqueta: '‚Äî' }

            if (p <= 1) {
              // Ej: 0.2 ‚Üí 20% del subtotal
              return { monto: subtotal * p, etiqueta: (p * 100).toFixed(2) + '%' }
            }

            // Cualquier n√∫mero mayor a 1 se trata como porcentaje
            return { monto: subtotal * (p / 100), etiqueta: p.toFixed(2) + '%' }
          }

          const renderTabla = () => {
            const conceptos = []
            let subtotal = 0

            const numeroModulos = getNumeroDeModulos() || 1

            // ids que siempre se multiplican por N
            const idsSiemprePorModulo = new Set(['panel', 'materiales', 'estructura', "instalacion"])

            // si el inversor es "Microinversor", entonces tambi√©n multiplicar "inversor"
            const multiplicarInversor = (inversorOmicro && String(inversorOmicro) === 'Microinversor')

            IDS_COSTOS.forEach(([id, nombre]) => {
              let val = toNumber($(id)?.value)
              let etiqueta = nombre

              const debeMultiplicarse = idsSiemprePorModulo.has(id) || (id === 'inversor' && multiplicarInversor)

              if (debeMultiplicarse) {
                val = val * numeroModulos
                etiqueta = `${nombre} (x${numeroModulos})`
                console.log(`Multiplicando ${nombre} por ${numeroModulos}:`, etiqueta)
              }

              conceptos.push({ nombre: etiqueta, val })
              subtotal += val
            })

            const { monto: profit, etiqueta: etiquetaProfit } = calcularProfit(subtotal)
            const base = subtotal + profit
            const iva = base * IVA_RATE
            const total = base + iva

            const potenciaW = getPotenciaW()
            const pricePerWatt = potenciaW ? subtotal / potenciaW : null

            const results = $('resultsContent')
            if (!results) return
            let cont = document.getElementById('cont-desglose-cotizacion-pu')
            if (!cont) {
              cont = document.createElement('section')
              cont.id = 'cont-desglose-cotizacion-pu'
              cont.style.marginTop = '1.5rem'
              results.appendChild(cont)
            }
            const datasistema = localStorage.getItem("resultadosSistemaSolar")
            if (datasistema) {
              const resultados = JSON.parse(datasistema)
              console.log("Resultados del sistema solar:", resultados)
            }
            let reoysinIva = base / resultados.consumoAnualDeEnergia;
            let roiConiva = total / resultados.consumoAnualDeEnergia;
            // Guardar resultados en localStorage
            const datosParaGuardar = {
              conceptos,
              subtotal,
              profit,
              base,
              iva,
              total,
              pricePerWatt: pricePerWatt || 0,
              numeroModulos: numeroModulos,
              reoysinIva: reoysinIva || 0,
              roiConiva: roiConiva || 0
            };
            localStorage.setItem("cotizacionPU", JSON.stringify(datosParaGuardar));
            console.log("Cotizaci√≥n P.U. guardada en localStorage:", datosParaGuardar);

            const cardStyle = `
      background:#fff;border:1px solid #e2e8f0;border-radius:12px;
      padding:16px;box-shadow:0 4px 10px rgba(17,24,39,.06);overflow:auto
    `
            const titleStyle = `font-weight:600;font-size:1rem;margin:0 0 .6rem 0;display:flex;gap:.5rem;align-items:center`
            const tableStyle = `width:100%;border-collapse:collapse;font-size:.95rem`
            const thtd = `padding:.6rem .7rem;border-bottom:1px solid #edf2f7;text-align:right`
            const thLeft = `text-align:left`

            const filasConceptos = conceptos
              .filter(c => c.val && c.val !== 0)
              .map(c => `
        <tr>
          <td style="${thtd};${thLeft}">${c.nombre}</td>
          <td style="${thtd}">${fmt(c.val)}</td>
        </tr>
      `).join('')

            cont.innerHTML = `
      <div style="${cardStyle}">
        <h3 style="${titleStyle}">
          <i class="fas fa-file-invoice-dollar"></i>
          Desglose de Cotizaci√≥n P.U.
        </h3>
        <table style="${tableStyle}">
          <thead>
            <tr>
              <th style="${thtd};${thLeft}">Concepto</th>
              <th style="${thtd}">Importe</th>
            </tr>
          </thead>
          <tbody>
            ${filasConceptos || `
              <tr><td style="${thtd};${thLeft}" colspan="2">Sin datos de cotizaci√≥n a√∫n.</td></tr>
            `}
            <tr>
              <td style="${thtd};${thLeft};font-weight:600">Subtotal 1</td>
              <td id="subtotalDisplay" style="${thtd};font-weight:600">${fmt(subtotal)}</td>
            </tr>
            <tr>
              <td style="${thtd};${thLeft}">Profit <span style="opacity:.7">(${etiquetaProfit})</span></td>
              <td style="${thtd}">${fmt(profit)}</td>
            </tr>
            <tr>
              // <td style="${thtd};${thLeft};font-weight:600">Subtotal 2</td>
              <td style="${thtd};font-weight:600">${fmt(base)}</td>
            </tr>
            <tr>
              <td style="${thtd};${thLeft}">IVA (${(IVA_RATE * 100).toFixed(0)}%)</td>
              <td id="ivaDisplay" style="${thtd}">${fmt(iva)}</td>
            </tr>
            <tr>
              <td style="${thtd};${thLeft};font-weight:700">TOTAL</td>
              <td id="totalDisplay" style="${thtd};font-weight:700">${fmt(total)}</td>
            </tr>
            ${pricePerWatt !== null ? `
              <tr>
                <td style="${thtd};${thLeft}">$/Watt (sin IVA)</td>
                <td style="${thtd}">${pricePerWatt.toLocaleString('es-MX', { maximumFractionDigits: 2 })}</td>
              </tr>
              <tr>
                <td style="${thtd};${thLeft}">$/Watt (con IVA)</td>
                <td style="${thtd}">${(pricePerWatt * (1 + IVA_RATE)).toLocaleString('es-MX', { maximumFractionDigits: 2 })}</td>
              </tr>
            ` : ``}
          </tbody>
        </table>
        <div style="margin-top:.6rem;font-size:.85rem;color:#64748b">
          * La fila <em>$/Watt</em> aparece cuando la tarjeta <strong>Potencia Instalada (kW)</strong> ya tiene valor.
        </div>
      </div>
    `
          }

          const attach = () => {
            const ids = IDS_COSTOS.map(([id]) => id).concat(['profit'])
            ids.forEach(id => {
              const el = $(id)
              if (el) el.addEventListener('input', renderTabla)
            })
            const pot = $('potenciaInstalada')
            if (pot) {
              const mo = new MutationObserver(renderTabla)
              mo.observe(pot, { childList: true, characterData: true, subtree: true })
            }
            renderTabla()
          }

          if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', attach)
          } else {
            attach()
          }
        })()




      </script>

      <script>
          (() => {
            // Campos que S√ç se suman (profit NO est√° aqu√≠)
            const IDS_SUM = [
              "panel", "inversor", "monitoreo", "estructura", "materiales",
              "instalacion", "carpeta", "flete", "interconexion", "uve", "uie", "medidor"
            ];

            const $ = id => document.getElementById(id);

            const toNumber = v => {
              if (v == null) return 0;
              const s = String(v).replace(/[^\d.-]/g, "");
              const n = parseFloat(s);
              return isNaN(n) ? 0 : n;
            };

            const formatOut = (n, out) =>
              (out?.type === "number")
                ? Number(n).toFixed(2)
                : Number(n).toLocaleString("es-MX", { minimumFractionDigits: 2, maximumFractionDigits: 2 });

            function calcularTotal() {
              let total = 0;
              IDS_SUM.forEach(id => { total += toNumber($(id)?.value); });

              // NO sumar profit. Solo lo leemos para disparar rec√°lculo si cambia.
              const out = $("total");
              if (out) out.value = formatOut(total, out);
            }

            function attach() {
              // Escucha todos los permitidos‚Ä¶
              IDS_SUM.forEach(id => { const el = $(id); if (el) el.addEventListener("input", calcularTotal); });
              // ‚Ä¶y tambi√©n profit para que al cambiarlo NO sume pero s√≠ se recalculen otros efectos si tuvieses.
              const profit = $("profit");
              if (profit) profit.addEventListener("input", calcularTotal);

              calcularTotal();
            }

            document.readyState === "loading"
              ? document.addEventListener("DOMContentLoaded", attach)
              : attach();
          })();
      </script>




      <button class="calculate-btn" id="btnNuevoCalculo" onclick="nuevoCalculo()">
        <i class="fas fa-redo"></i>
        <span>Nuevo C√°lculo</span>
      </button>
      <!-- Bot√≥n de c√°lculofffffff -->
      <button class="calculate-btn" id="btnCalcular" onclick="if(validarFormulario()) calcularSistemaSolar()"
        style="display:flex;" aria-live="polite">
        <i class="fas fa-calculator"></i>
        <span>Calcular Sistema Solar</span>
      </button>
      <script>
        // Asegura que el bot√≥n Calcular est√© siempre visible y habilitado en mobile/tablet al cargar
        document.addEventListener('DOMContentLoaded', function () {
          var btnCalc = document.getElementById('btnCalcular');
          if (btnCalc) {
            btnCalc.style.display = 'flex';
            btnCalc.disabled = false;
          }
        });
      </script>

      <button class="calculate-btn-c mobile-only" id="btnCotizarMobile" onclick="exportToBasePdf()">
        <i class="fas fa-file-contract"></i>
        <span>Generar Cotizaci√≥n</span>
      </button>


    </div>


    <script>
      function nuevoCalculo() {
        // üîπ Borrar TODO el localStorage
        localStorage.clear();
        console.log("LocalStorage limpiado completamente");

        // Reactivar bot√≥n calcular
        const btnCalc = document.getElementById("btnCalcular");
        if (btnCalc) btnCalc.disabled = false;

        // Ocultar el bot√≥n de cotizaci√≥n m√≥vil
        const btnCot = document.getElementById("btnCotizarMobile");
        if (btnCot) {
          btnCot.classList.remove("show");
          btnCot.disabled = true;
          btnCot.setAttribute("hidden", "true");
        }

        // Limpiar resultados en pantalla
        const results = document.getElementById("resultsContent");
        const placeholder = document.getElementById("resultsPlaceholder");
        if (results) results.style.display = "none";
        if (placeholder) placeholder.style.display = "flex";

        // üîπ Limpiar TODOS los inputs
        document.querySelectorAll("input").forEach(i => {
          if (i.type === "checkbox" || i.type === "radio") {
            i.checked = false;
          } else {
            i.value = "";
          }
        });

        // üîπ Limpiar TODOS los selects
        document.querySelectorAll("select").forEach(s => {
          s.selectedIndex = 0;
        });

        // üîπ Limpiar TODOS los textareas
        document.querySelectorAll("textarea").forEach(t => {
          t.value = "";
        });

        // üîπ Hacer scroll al inicio (para mobile)
        window.scrollTo({ top: 0, behavior: 'smooth' });
      }

      // Exportar funci√≥n al global
      window.nuevoCalculo = nuevoCalculo;

    </script>




    <!-- üî∏ Barra que permite redimensionar -->
    <div class="resizer" id="splitter" aria-label="Arrastra para ajustar"></div>

    <!-- Panel derecho - Resultados -->
    <div class="results-panel">
      <!-- Estado inicial -->
      <div class="results-placeholder" id="resultsPlaceholder">
        <img src="img/logo.png" alt="Hexa Solar Logo" style="height:64px; margin-bottom:12px; opacity:0.5;">
        <h3>An√°lisis Solar Inteligente</h3>
        <p>Complete los datos del formulario y presione "Calcular Sistema Solar" para ver los resultados detallados</p>
      </div>

      <!-- Contenido de resultados -->
      <div class="results-content" id="resultsContent">
        <div class="results-header">
          <div class="results-title">An√°lisis Completado</div>
          <div class="results-subtitle">Sistema Solar Fotovoltaico Optimizado</div>
        </div>

        <div class="metrics-grid">
          <div class="metric-card">
            <div class="metric-icon"><i class="fas fa-bolt"></i></div>
            <div class="metric-value" id="consumoAnual">-</div>
            <div class="metric-label">Consumo Anual (kWh)</div>
          </div>
          <div class="metric-card">
            <div class="metric-icon"><i class="fas fa-calendar-day"></i></div>
            <div class="metric-value" id="consumoMensual">-</div>
            <div class="metric-label">Consumo Mensual Promedio</div>
          </div>
          <div class="metric-card">
            <div class="metric-icon"><i class="fas fa-sun"></i></div>
            <div class="metric-value" id="consumoDiario">-</div>
            <div class="metric-label">Consumo Diario Promedio</div>
          </div>
          <div class="metric-card">
            <div class="metric-icon"><i class="fas fa-dollar-sign"></i></div>
            <div class="metric-value" id="importeTotal">-</div>
            <div class="metric-label">Importe de CFE Total Anual</div>
          </div>
          <div class="metric-card">
            <div class="metric-icon"><i class="fas fa-coins"></i></div>
            <div class="metric-value" id="importePromedio">-</div>
            <div class="metric-label">Importe Promedio</div>
          </div>
          <div class="metric-card">
            <div class="metric-icon"><i class="fas fa-calculator"></i></div>
            <div class="metric-value" id="tarifaPromedio">-</div>
            <div class="metric-label">Tarifa Promedio ($/kWh)</div>
          </div>
          <div class="metric-card">
            <div class="metric-icon"><i class="fas fa-percentage"></i></div>
            <div class="metric-value" id="porcentajeAhorro">-</div>
            <div class="metric-label">% de Ahorro</div>
          </div>
          <!-- <div class="metric-card">
              <div class="metric-icon"><i class="fas fa-thermometer-half"></i></div>
              <div class="metric-value" id="tempMin">-</div>
              <div class="metric-label">Temp Min (¬∞C)</div>
            </div> -->
          <!-- <div class="metric-card">
              <div class="metric-icon"><i class="fas fa-thermometer-full"></i></div>
              <div class="metric-value" id="tempMax">-</div>
              <div class="metric-label">Temp Max (¬∞C)</div>
            </div> -->
          <div class="metric-card">
            <div class="metric-icon"><i class="fas fa-plug"></i></div>
            <div class="metric-value" id="potenciaNecesaria">-</div>
            <div class="metric-label">Potencia Necesaria (kW)</div>
          </div>
          <div class="metric-card">
            <div class="metric-icon"><i class="fas fa-solar-panel"></i></div>
            <div class="metric-value" id="numeroModulos">-</div>
            <div class="metric-label">M√≥dulos Requeridos</div>
          </div>
          <!-- <div class="metric-card">
              <div class="metric-icon"><i class="fas fa-industry"></i></div>
              <div class="metric-value" id="generacionAnual">-</div>
              <div class="metric-label">Generaci√≥n Anual (kWh)</div>
            </div> -->
          <div class="metric-card">
            <div class="metric-icon"><i class="fas fa-expand-arrows-alt"></i></div>
            <div class="metric-value" id="potenciaInstalada">-</div>
            <div class="metric-label">Potencia Instalada (kW)</div>
          </div>
          <div class="metric-card">
            <div class="metric-icon"><i class="fas fa-sun"></i></div>
            <div class="metric-value" id="hsp">-</div>
            <div class="metric-label">Horas Solares Pico</div>
          </div>
          <div class="metric-card">
            <div class="metric-icon"><i class="fas fa-leaf"></i></div>
            <div class="metric-value" id="ahorroCO2">-</div>
            <div class="metric-label">Ahorro CO‚ÇÇ (t/a√±o)</div>
          </div>
          <div class="metric-card">
            <div class="metric-icon"><i class="fas fa-tree"></i></div>
            <div class="metric-value" id="arboles">-</div>
            <div class="metric-label">√Årboles Equivalentes</div>
          </div>
          <div class="metric-card">
            <div class="metric-icon"><i class="fas fa-bolt"></i></div>
            <div class="metric-value" id="generacionAnual">-</div>
            <div class="metric-label">Generaci√≥n anual aproximada</div>
          </div>
          <div class="metric-card">
            <div class="metric-icon"><i class="fas fa-percentage"></i></div>
            <div class="metric-value" id="porcentajeGeneracion">-</div>
            <div class="metric-label">Porcentaje de generaci√≥n</div>
          </div>
          <div class="metric-card">
            <div class="metric-icon"><i class="fas fa-arrow-rotate-left"></i></div>
            <div class="metric-value" id="roi">-</div>
            <div class="metric-label">ROI</div>
          </div>
        </div>

        <div class="chart-section">
          <div class="chart-header"><i class="fas fa-chart-bar"></i> Gr√°fica de Irradiaci√≥n Solar</div>
          <div class="chart-container"><canvas id="irradiacionChart" width="800" height="400"></canvas></div>
        </div>

        <div class="details-table">
          <div class="table-header"><i class="fas fa-table"></i> An√°lisis Detallado por Per√≠odo</div>
          <div class="table-content">
            <div class="table-row" style="font-weight: 600; background: rgba(16, 185, 129, 0.1);">
              <div class="table-cell">Per√≠odo</div>
              <div class="table-cell">Consumo (kWh)</div>
              <div class="table-cell">Importe ($)</div>
              <div class="table-cell">Tarifa ($/kWh)</div>
            </div>
            <div id="detalleTableBody"></div>
          </div>
        </div>

        <!-- <div class="chart-section">
          <div class="chart-header"><i class="fas fa-chart-bar"></i> Impacto de la Generaci√≥n vs Consumo</div>
          <div class="chart-container"><canvas id="impactoChart" width="800" height="400"></canvas></div>
        </div> -->

        <div id="impactoWrapper" style="width:100%;max-width:900px">
          <canvas id="impactoChart" style="width:100%;height:320px;"></canvas>
        </div>



        <div id="cont-desglose-cotizacion-pu"></div>
        <button class="calculate-btn" onclick="exportToBasePdf()">
          <i class="fas fa-file-contract"></i>
          <span>Generar Cotizaci√≥n</span>
        </button>
      </div>
    </div>
  </div>

  <!-- Loading overlay -->
  <div class="loading-overlay" id="loading">
    <div class="loading-content">
      <div class="loading-spinner"><i class="fas fa-solar-panel fa-spin"></i></div>
      <div class="loading-text">Procesando Datos</div>
      <div class="loading-subtext">Consultando irradiaci√≥n solar...</div>
    </div>
  </div>

  <script src="js/data-manager.js"></script>
  <script src="js/script.js"></script>
  <script src="js/scriptpdf.js"></script>

  <!-- JS de la barra resizable -->
  <script>
    (function () {
      const container = document.querySelector('.main-container');
      const left = document.querySelector('.form-panel');
      const resizer = document.getElementById('splitter');
      if (!container || !left || !resizer) return;

      const MIN_LEFT = 320;   // px
      const MIN_RIGHT = 320;  // px

      let startX = 0, startW = 0, dragging = false;

      function clampLeftWidth(px) {
        const total = container.getBoundingClientRect().width;
        const maxByRight = total - MIN_RIGHT;
        return Math.max(MIN_LEFT, Math.min(maxByRight, px));
      }
      function setLeftWidth(px) {
        const w = clampLeftWidth(px);
        left.style.width = w + 'px';
        left.style.flex = `0 0 ${w}px`;
      }
      function setHalf() {
        const total = container.getBoundingClientRect().width;
        setLeftWidth(total / 2);
      }
      function onPointerDown(e) {
        dragging = true;
        startX = (e.touches ? e.touches[0].clientX : e.clientX);
        startW = left.getBoundingClientRect().width;
        document.body.classList.add('is-resizing');
        resizer.classList.add('is-dragging');

        window.addEventListener('pointermove', onPointerMove);
        window.addEventListener('pointerup', onPointerUp);
        window.addEventListener('touchmove', onTouchMove, { passive: false });
        window.addEventListener('touchend', onPointerUp);
        window.addEventListener('mousemove', onMouseMove);
        window.addEventListener('mouseup', onPointerUp);
      }
      function onPointerMove(e) { if (!dragging) return; const dx = e.clientX - startX; setLeftWidth(startW + dx); }
      function onMouseMove(e) { if (!dragging) return; const dx = e.clientX - startX; setLeftWidth(startW + dx); }
      function onTouchMove(e) { if (!dragging) return; e.preventDefault(); const dx = e.touches[0].clientX - startX; setLeftWidth(startW + dx); }
      function onPointerUp() {
        dragging = false;
        document.body.classList.remove('is-resizing');
        resizer.classList.remove('is-dragging');
        window.removeEventListener('pointermove', onPointerMove);
        window.removeEventListener('pointerup', onPointerUp);
        window.removeEventListener('touchmove', onTouchMove);
        window.removeEventListener('touchend', onPointerUp);
        window.removeEventListener('mousemove', onMouseMove);
        window.removeEventListener('mouseup', onPointerUp);
      }
      resizer.addEventListener('pointerdown', onPointerDown);
      resizer.addEventListener('mousedown', onPointerDown);
      resizer.addEventListener('touchstart', onPointerDown, { passive: true });
      window.addEventListener('load', setHalf);
      window.addEventListener('resize', setHalf);
      setTimeout(setHalf, 0);
    })();
  </script>

  <!-- JS para el panel de Consumo -->
  <script>

    //no borrar esta funcion, esta es la funcion que genera los inputs de consumo
    // function generarInputsConsumo() {
    //   const select = document.getElementById('tipoPeriodo');
    //   const n = (select && select.value === 'mensual') ? 12 : 6;

    //   const kwhRow = document.getElementById('kwhRow');
    //   const pagoRow = document.getElementById('pagoRow');
    //   const tarifaRow = document.getElementById('tarifaRow');
    //   if (!kwhRow || !pagoRow || !tarifaRow) return;

    //   kwhRow.innerHTML = '';
    //   pagoRow.innerHTML = '';
    //   tarifaRow.innerHTML = '';

    //   // Periodos seg√∫n tipo
    //   const periodosMensuales = [
    //     "Ene", "Feb", "Mar", "Abr", "May", "Jun",
    //     "Jul", "Ago", "Sep", "Oct", "Nov", "Dic"
    //   ];
    //   const periodosBimestrales = [
    //     "Bim 1", "Bim 2", "Bim 3",
    //     "Bim 4", "Bim 5", "Bim 6"
    //   ];

    //   const periodos = (n === 12) ? periodosMensuales : periodosBimestrales;

    //   const toNum = (v) => {
    //     if (v === null || v === undefined) return NaN;
    //     const s = String(v).trim().replace(',', '.');
    //     const x = parseFloat(s);
    //     return Number.isFinite(x) ? x : NaN;
    //   };
    //   const hasNum = (v) => !Number.isNaN(toNum(v));
    //   const fix2 = (x) => (Math.round((x + Number.EPSILON) * 100) / 100).toFixed(2);

    //   const recalcular = (i, source) => {
    //     const k = document.getElementById(`consumo${i}`);
    //     const p = document.getElementById(`importe${i}`);
    //     const t = document.getElementById(`tarifa${i}`);

    //     const consumo = toNum(k.value);
    //     const importe = toNum(p.value);
    //     const tarifa = toNum(t.value);

    //     if (source === 'importe') {
    //       if (hasNum(consumo) && consumo > 0 && hasNum(importe)) {
    //         t.value = fix2(importe / consumo);
    //       }
    //       return;
    //     }

    //     if (source === 'tarifa') {
    //       if (hasNum(consumo) && consumo > 0 && hasNum(tarifa)) {
    //         p.value = fix2(tarifa * consumo);
    //       }
    //       return;
    //     }

    //     if (source === 'consumo') {
    //       if (hasNum(consumo) && consumo > 0) {
    //         if (hasNum(importe) && importe > 0) {
    //           t.value = fix2(importe / consumo);
    //         } else if (!hasNum(importe) || importe === 0) {
    //           if (hasNum(tarifa) && tarifa > 0) {
    //             p.value = fix2(tarifa * consumo);
    //           }
    //         }
    //       }
    //       return;
    //     }
    //   };

    //   for (let i = 1; i <= n; i++) {
    //     const periodo = periodos[i - 1] || `Periodo ${i}`;

    //     // Etiqueta
    //     const label = document.createElement('div');
    //     label.textContent = periodo;
    //     label.style.fontSize = "12px";
    //     label.style.fontWeight = "normal";
    //     label.style.color = "#6c757d";
    //     label.style.textAlign = "center";
    //     label.style.marginBottom = "2px";

    //     // Contenedor vertical
    //     const contK = document.createElement('div');
    //     contK.style.display = "flex";
    //     contK.style.flexDirection = "column";
    //     contK.style.alignItems = "center";
    //     contK.style.margin = "0 5px";

    //     const contP = contK.cloneNode(false);
    //     const contT = contK.cloneNode(false);

    //     // Consumo (kWh)
    //     const k = document.createElement('input');
    //     k.type = 'number';
    //     k.step = 'any';
    //     k.inputMode = 'decimal';
    //     k.className = 'consumo-input';
    //     k.id = `consumo${i}`;
    //     k.addEventListener('input', () => recalcular(i, 'consumo'));
    //     contK.appendChild(label.cloneNode(true));
    //     contK.appendChild(k);

    //     // Importe ($)
    //     const p = document.createElement('input');
    //     p.type = 'number';
    //     p.step = 'any';
    //     p.inputMode = 'decimal';
    //     p.className = 'consumo-input';
    //     p.id = `importe${i}`;
    //     p.addEventListener('input', () => recalcular(i, 'importe'));
    //     contP.appendChild(label.cloneNode(true));
    //     contP.appendChild(p);

    //     // Tarifa ($/kWh)
    //     const t = document.createElement('input');
    //     t.type = 'number';
    //     t.step = 'any';
    //     t.inputMode = 'decimal';
    //     t.className = 'consumo-input';
    //     t.id = `tarifa${i}`;
    //     t.addEventListener('input', () => recalcular(i, 'tarifa'));
    //     contT.appendChild(label.cloneNode(true));
    //     contT.appendChild(t);

    //     kwhRow.appendChild(contK);
    //     pagoRow.appendChild(contP);
    //     tarifaRow.appendChild(contT);
    //   }
    // }
    function generarInputsConsumo() {
      const select = document.getElementById('tipoPeriodo');
      const n = (select && select.value === 'mensual') ? 12 : 6;

      const kwhRow = document.getElementById('kwhRow');
      const pagoRow = document.getElementById('pagoRow');
      const tarifaRow = document.getElementById('tarifaRow');
      if (!kwhRow || !pagoRow || !tarifaRow) return;

      // Limpiar contenedores
      kwhRow.innerHTML = '';
      pagoRow.innerHTML = '';
      tarifaRow.innerHTML = '';

      // Etiquetas por per√≠odo
      const periodosMensuales = ["Ene", "Feb", "Mar", "Abr", "May", "Jun", "Jul", "Ago", "Sep", "Oct", "Nov", "Dic"];
      const periodosBimestrales = ["Bim 1", "Bim 2", "Bim 3", "Bim 4", "Bim 5", "Bim 6"];
      const periodos = (n === 12) ? periodosMensuales : periodosBimestrales;

      // Helpers
      const toNum = (v) => {
        if (v === null || v === undefined) return NaN;
        const x = parseFloat(String(v).trim().replace(',', '.'));
        return Number.isFinite(x) ? x : NaN;
      };
      const hasNum = (v) => !Number.isNaN(toNum(v));
      const fix2 = (x) => (Math.round((x + Number.EPSILON) * 100) / 100).toFixed(2);

      const recalcular = (i, source) => {
        const k = document.getElementById(`consumo${i}`);
        const p = document.getElementById(`importe${i}`);
        const t = document.getElementById(`tarifa${i}`);

        const consumo = toNum(k.value);
        const importe = toNum(p.value);
        const tarifa = toNum(t.value);

        if (source === 'importe') {
          if (hasNum(consumo) && consumo > 0 && hasNum(importe)) t.value = fix2(importe / consumo);
        } else if (source === 'tarifa') {
          if (hasNum(consumo) && consumo > 0 && hasNum(tarifa)) p.value = fix2(tarifa * consumo);
        } else if (source === 'consumo') {
          if (hasNum(consumo) && consumo > 0) {
            if (hasNum(importe) && importe > 0) {
              t.value = fix2(importe / consumo);
            } else if ((!hasNum(importe) || importe === 0) && hasNum(tarifa) && tarifa > 0) {
              p.value = fix2(tarifa * consumo);
            }
          }
        }

        // Si tienes funciones globales para totales, ll√°malas sin romper si no existen
        window.actualizarTotales?.();
        window.actualizarTotalesConsumo?.();
      };

      // Construcci√≥n de inputs
      for (let i = 1; i <= n; i++) {
        const periodo = periodos[i - 1] || `Periodo ${i}`;

        // Mini etiqueta
        const makeLabel = () => {
          const d = document.createElement('div');
          d.textContent = periodo;
          d.style.fontSize = "12px";
          d.style.fontWeight = "normal";
          d.style.color = "#6c757d";
          d.style.textAlign = "center";
          d.style.marginBottom = "2px";
          return d;
        };

        const baseCol = () => {
          const d = document.createElement('div');
          d.style.display = "flex";
          d.style.flexDirection = "column";
          d.style.alignItems = "center";
          d.style.margin = "0 5px";
          return d;
        };

        // Consumo (kWh)
        const contK = baseCol();
        const k = document.createElement('input');
        k.type = 'number'; k.step = 'any'; k.inputMode = 'decimal';
        k.className = 'consumo-input'; k.id = `consumo${i}`;
        k.placeholder = '0';
        k.addEventListener('input', () => recalcular(i, 'consumo'));
        contK.appendChild(makeLabel());
        contK.appendChild(k);

        // Importe ($)
        const contP = baseCol();
        const p = document.createElement('input');
        p.type = 'number'; p.step = 'any'; p.inputMode = 'decimal';
        p.className = 'consumo-input'; p.id = `importe${i}`;
        p.placeholder = '0';
        p.addEventListener('input', () => recalcular(i, 'importe'));
        contP.appendChild(makeLabel());
        contP.appendChild(p);

        // Tarifa ($/kWh)
        const contT = baseCol();
        const t = document.createElement('input');
        t.type = 'number'; t.step = 'any'; t.inputMode = 'decimal';
        t.className = 'consumo-input'; t.id = `tarifa${i}`;
        t.placeholder = '0';
        t.addEventListener('input', () => recalcular(i, 'tarifa'));
        contT.appendChild(makeLabel());
        contT.appendChild(t);

        kwhRow.appendChild(contK);
        pagoRow.appendChild(contP);
        tarifaRow.appendChild(contT);
      }

      // Llama a los totales al finalizar render
      window.actualizarTotales?.();
      window.actualizarTotalesConsumo?.();
    }


    //valores de preuba, quitar en produccion

    // function generarInputsConsumo() {
    //   const select = document.getElementById('tipoPeriodo');
    //   const n = (select && select.value === 'mensual') ? 12 : 6;

    //   const kwhRow = document.getElementById('kwhRow');
    //   const pagoRow = document.getElementById('pagoRow');
    //   const tarifaRow = document.getElementById('tarifaRow');
    //   if (!kwhRow || !pagoRow || !tarifaRow) return;

    //   kwhRow.innerHTML = '';
    //   pagoRow.innerHTML = '';
    //   tarifaRow.innerHTML = '';

    //   // Valores por defecto (kWh, Importe)
    //   const valores = [
    //     [690.00, 1695.00],
    //     [631.00, 1685.00],
    //     [422.00, 489.00],
    //     [970.00, 2798.00],
    //     [1011.00, 2998.00],
    //     [752.00, 2269.00]
    //   ];

    //   const toNum = (v) => {
    //     const x = parseFloat(v);
    //     return Number.isFinite(x) ? x : 0;
    //   };

    //   const fix2 = (x) => (Math.round((x + Number.EPSILON) * 100) / 100).toFixed(2);

    //   // Reglas:
    //   // - Si importe > 0 => tarifa = importe/consumo (si consumo > 0)
    //   // - Si importe == 0 o vac√≠o y tarifa > 0 => importe = tarifa*consumo
    //   // - Si ambos vac√≠os/0 => ambos 0
    //   const recalcular = (i) => {
    //     const k = document.getElementById(`consumo${i}`);
    //     const p = document.getElementById(`importe${i}`);
    //     const t = document.getElementById(`tarifa${i}`);

    //     const consumo = toNum(k.value);
    //     let importe = toNum(p.value);
    //     let tarifa = toNum(t.value);

    //     if (importe > 0) {
    //       // Usuario ingres√≥ (o hay) importe
    //       if (consumo > 0) {
    //         tarifa = importe / consumo;
    //         t.value = fix2(tarifa);
    //       } else {
    //         // Consumo 0 => tarifa 0 porque no se puede dividir
    //         t.value = '0.00';
    //       }
    //     } else {
    //       // No hay importe => si hay tarifa, calcular importe
    //       if (tarifa > 0 && consumo > 0) {
    //         importe = tarifa * consumo;
    //         p.value = fix2(importe);
    //       } else {
    //         // No hay informaci√≥n suficiente
    //         p.value = '0.00';
    //         t.value = '0.00';
    //       }
    //     }
    //   };

    //   for (let i = 1; i <= n; i++) {
    //     // Consumo (kWh)
    //     const k = document.createElement('input');
    //     k.type = 'number';
    //     k.step = '0.01';
    //     k.className = 'consumo-input';
    //     k.id = `consumo${i}`;
    //     k.value = valores[i - 1] ? valores[i - 1][0] : 0;
    //     k.addEventListener('input', () => recalcular(i));
    //     kwhRow.appendChild(k);

    //     // Importe ($)
    //     const p = document.createElement('input');
    //     p.type = 'number';
    //     p.step = '0.01';
    //     p.className = 'consumo-input';
    //     p.id = `importe${i}`;
    //     p.placeholder = '0.00'; // Si lo dejan vac√≠o/0, se calcular√° desde tarifa
    //     p.value = valores[i - 1] ? valores[i - 1][1] : 0;
    //     p.addEventListener('input', () => recalcular(i));
    //     pagoRow.appendChild(p);

    //     // Tarifa ($/kWh)
    //     const t = document.createElement('input');
    //     t.type = 'number';
    //     t.step = '0.01';
    //     t.className = 'tarifa-input';
    //     t.id = `tarifa${i}`;
    //     t.placeholder = '0.00'; // Si hay tarifa y no hay importe, calcular√° el importe
    //     t.addEventListener('input', () => recalcular(i));
    //     tarifaRow.appendChild(t);

    //     // Inicial: si hay importe y consumo, calcular tarifa; si no, dejar 0
    //     const consumoInit = toNum(k.value);
    //     const importeInit = toNum(p.value);
    //     if (importeInit > 0 && consumoInit > 0) {
    //       t.value = fix2(importeInit / consumoInit);
    //     } else {
    //       t.value = '0.00';
    //     }
    //   }
    // }

    // window.addEventListener('load', generarInputsConsumo);
    // document.getElementById('tipoPeriodo')?.addEventListener('change', generarInputsConsumo);
  </script>

  <!-- JS: Regi√≥n tarifaria CFE autom√°tica seg√∫n estado -->
  <script>
    (function () {
      const estadoProyecto = document.getElementById('estadoProyecto');
      const regionInput = document.getElementById('regionTarifariaCFE');

      const regiones = {
        "Regi√≥n Norte": ["Chihuahua", "Coahuila", "Nuevo Le√≥n", "Durango"],
        "Regi√≥n Noreste": ["San Luis Potos√≠", "Tamaulipas"],
        "Regi√≥n Noroeste": ["Sonora", "Sinaloa"],
        "Regi√≥n Baja California": ["Baja California"],
        "Regi√≥n Baja California Sur": ["Baja California Sur"],
        "Regi√≥n Peninsular": ["Yucat√°n", "Campeche", "Quintana Roo"],
        "Regi√≥n Central": ["Ciudad de M√©xico", "Estado de M√©xico", "Morelos", "Tlaxcala", "Puebla", "Hidalgo"],
        "Regi√≥n Sur": ["Zacatecas", "Michoac√°n", "Guerrero", "Oaxaca", "Chiapas", "Veracruz", "Tabasco", "Aguascalientes", "Colima", "Guanajuato", "Jalisco", "Nayarit", "Quer√©taro"]
      };

      function obtenerRegion(estado) {
        for (const [region, lista] of Object.entries(regiones)) {
          if (lista.includes(estado)) return region;
        }
        return "";
      }

      function actualizarRegion() {
        const estadoSel = estadoProyecto ? estadoProyecto.value : "";
        if (regionInput) {
          regionInput.value = obtenerRegion(estadoSel);
        }
      }

      if (estadoProyecto) {
        estadoProyecto.addEventListener('change', actualizarRegion);
        window.addEventListener('load', actualizarRegion);
      }
    })();
  </script>
  <script>
    (function () {
      // Cambia la tasa si lo necesitas (16% en MX)
      const IVA_RATE = 0.16;

      // IDs de TODAS las partidas que suman al subtotal
      const PARTIDAS = [
        "panel", "inversor", "monitoreo", "estructura", "materiales",
        "instalacion", "carpeta", "flete", "interconexion", "uve",
        "uie", "medidor", "profit", "watts"
      ];

      const $subtotal = document.getElementById("subtotal");
      const $iva = document.getElementById("iva");
      const $total = document.getElementById("total");

      // Asegura que Subtotal / IVA / Total no sean editables
      [$subtotal, $iva, $total].forEach(el => {
        if (el) {
          el.readOnly = true;
          el.style.background = "#f8fafc"; // opcional, para verse "deshabilitado"
        }
      });

      const toNumber = (v) => {
        const n = parseFloat(String(v).replace(/,/g, ""));
        return isNaN(n) ? 0 : n;
      };

      function recalc() {
        let subtotal = 0;
        PARTIDAS.forEach(id => {
          const el = document.getElementById(id);
          if (el) subtotal += toNumber(el.value);
        });

        const iva = subtotal * IVA_RATE;
        const total = subtotal + iva;

        if ($subtotal) $subtotal.value = subtotal.toFixed(2);
        if ($iva) $iva.value = iva.toFixed(2);
        if ($total) $total.value = total.toFixed(2);
      }

      // Recalcular cuando se cambie cualquier partida
      PARTIDAS.forEach(id => {
        const el = document.getElementById(id);
        if (el) el.addEventListener("input", recalc);
      });

      // Calcular al cargar
      window.addEventListener("load", recalc);
    })();
  </script>

  <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
  <script>
    function validarFormulario() {
      // üîπ Todos los IDs de tu formulario
      const obligatorios = [
        // Cliente
        // "nombreCliente","direccionCliente","estadoCliente","municipioCliente","telefonoCliente","correoCliente",
        // // Ejecutivo
        // "nombreEjecutivo","correoEjecutivo","folioCotizacion",
        // // Proyecto
        // "tipoProyecto","tipoTarifa","estadoProyecto","municipioProyecto",
        // // Dise√±o y dimensionamiento
        // "potenciaPanel","marcaPanel","modeloPanel","inversorPanel",
        // "areaAprox",
        // // Cotizaci√≥n P.U.
        // "panel","inversor","mantenimiento","estructura","materiales",
        // "instalacion","carpeta","flete","interconexion","uve","uie","medidor","profit"
      ];

      let valido = true;

      obligatorios.forEach(id => {
        const el = document.getElementById(id);
        if (!el) return;

        // ‚ö†Ô∏è Condici√≥n corregida: obligatorio pero se acepta "0"
        if (el.value === null || el.value.trim() === "") {
          valido = false;
          el.style.borderColor = "red";

          Toastify({
            text: `El campo "${id}" es obligatorio`,
            duration: 3000,
            gravity: "top",
            position: "right",
            backgroundColor: "linear-gradient(to right, #ef4444, #dc2626)",
            stopOnFocus: true
          }).showToast();

        } else {
          el.style.borderColor = "#cbd5e1";
        }
      });

      // üîπ Validaci√≥n especial: Microinversor ‚Üí requiere inversor lleno (pero puede ser "0")
      const inversorTipo = document.getElementById("inversorPanel").value;

      return valido;
    }
  </script>

  <script>
    // JS para el panel de C√°lculo en Vivo
(() => {
  // ===== CONFIG =====
  const $ = id => document.getElementById(id);
  const toNum = v => {
    if (v === null || v === undefined) return 0;
    const s = String(v).replace(/[^\d.-]/g, "");
    const n = parseFloat(s);
    return Number.isFinite(n) ? n : 0;
  };

  // Debounce para no recalcular en cada tecla
  let t = null;
  const schedule = () => { clearTimeout(t); t = setTimeout(recalcAll, 120); };

  // === 1) AUTOCOMPLETO CONSUMO / IMPORTE / TARIFA ===
  function wireConsumptionAutoFill() {
    const kwhRow = $("kwhRow");
    const pagoRow = $("pagoRow");
    const tarifaRow = $("tarifaRow");
    [kwhRow, pagoRow, tarifaRow].forEach(row => {
      if (!row) return;
      row.addEventListener("input", e => {
        const el = e.target;
        if (!(el instanceof HTMLInputElement)) return;

        // Detecta √≠ndice por el id: consumo3, importe3, tarifa3
        const m = el.id.match(/(consumo|importe|tarifa)(\d+)/);
        if (!m) { schedule(); return; }

        const [, tipo, idxStr] = m;
        const i = parseInt(idxStr, 10);

        const c = $("consumo" + i);
        const p = $("importe" + i);
        const r = $("tarifa" + i);

        const consumo = toNum(c?.value);
        const importe = toNum(p?.value);
        const tarifa  = toNum(r?.value);

        // Reglas de autocompletado ‚Äúsuaves‚Äù:
        // - Si hay consumo + tarifa y cambi√≥ alguno de esos ‚Üí rellena importe
        if ((el === c || el === r) && consumo > 0 && tarifa > 0) {
          if (p) p.value = (consumo * tarifa).toFixed(2);
        }
        // - Si hay consumo + importe y cambi√≥ alguno ‚Üí rellena tarifa
        if ((el === c || el === p) && consumo > 0 && importe > 0) {
          if (r) r.value = (importe / consumo).toFixed(3);
        }
        // - Si solo hay importe + tarifa ‚Üí rellena consumo
        if ((el === p || el === r) && importe > 0 && tarifa > 0 && (!consumo || el === r)) {
          if (c) c.value = (importe / tarifa).toFixed(0);
        }

        schedule();
      });
    });
  }

  // === 2) RE-C√ÅLCULO DE KPIs EN VIVO ===
  function readConsumosImportes() {
    const tipoPeriodo = $("tipoPeriodo")?.value || "bimestral";
    const n = (tipoPeriodo === "mensual") ? 12 : 6;

    const consumos = [];
    const importes = [];
    const tarifas  = [];
    let totalTarifas = 0, nTarifas = 0;

    for (let i = 0; i < n; i++) {
      const c = toNum($("consumo" + i)?.value);
      const p = toNum($("importe" + i)?.value);
      const rStr = $("tarifa" + i)?.value ?? "";
      const r = rStr === "" ? 0 : toNum(rStr);

      consumos.push(c);
      importes.push(p);
      tarifas.push(r);
      if (r > 0) { totalTarifas += r; nTarifas++; }
    }

    const consumoTotal = consumos.reduce((a,b) => a + b, 0);
    const consumoAnual = consumoTotal;         // <- NO duplicar por bimestral
    const consumoMensual = consumoAnual / 12;  // promedio mensual
    const consumoDiario = consumoAnual / 365;

    const importeTotalAnual = importes.reduce((a,b) => a + b, 0);
    const importePromedio   = importeTotalAnual / 12;
    const tarifaPromedio    = nTarifas > 0 ? (totalTarifas / nTarifas) : 0;

    return {
      tipoPeriodo, consumos, importes, tarifas,
      consumoAnual, consumoMensual, consumoDiario,
      importeTotalAnual, importePromedio, tarifaPromedio
    };
  }

  function recalcAll() {
    // Datos base
    const base = readConsumosImportes();

    // HSP y dise√±o (usar lo que haya disponible)
    const estado = $("estadoProyecto")?.value || "";
    let hsp = Number(window.hspValue);
    if (!Number.isFinite(hsp)) {
      // fallback si tienes hspData por estado (opcional)
      if (window.hspData && estado && Number.isFinite(window.hspData[estado])) {
        hsp = Number(window.hspData[estado]);
      }
    }
    if (!Number.isFinite(hsp) || hsp <= 0) hsp = 0;

    const potenciaPanel = toNum($("potenciaPanel")?.value); // Wp por m√≥dulo
    const inversorPanel = $("inversorPanel")?.value || "";
    const areaAprox     = toNum($("areaAprox")?.value);

    // C√°lculos de energ√≠a (solo si hay lo suficiente)
    let numeroModulos = 0, potenciaInstalada = 0, generacionAnual = 0, potenciaNecesaria = 0;
    if (potenciaPanel > 0 && hsp > 0) {
      // Usar tu misma l√≥gica ‚Äúsuave‚Äù
      potenciaNecesaria = base.consumoDiario / (hsp * 0.76);
      numeroModulos = Math.ceil((base.consumoDiario * 1000) / (hsp * potenciaPanel * 0.76));
      potenciaInstalada = (potenciaPanel * numeroModulos) / 1000;
      generacionAnual = numeroModulos * (potenciaPanel / 1000) * hsp * 365;
    }

    // Ahorros y eco ‚Äî si tienes produccionMensual, √∫sala; si no, usa generacionAnual
    let sumaGen = 0;
    const prodMens = JSON.parse(localStorage.getItem("produccionMensual") || "[]");
    if (Array.isArray(prodMens) && prodMens.length) {
      sumaGen = prodMens.reduce((a,b) => a + toNum(b), 0);
    } else {
      sumaGen = generacionAnual;
    }
    const ahorroCO2 = (sumaGen * 439.963) / 1_000_000;
    const arboles   = ahorroCO2 * 155;
    const porcentajeAhorro = (base.consumoAnual > 0 && generacionAnual > 0)
      ? (generacionAnual / base.consumoAnual) * 100
      : 0;

    // === Pintar tarjetas si existen ===
    const setTxt = (id, txt) => { const el = $(id); if (el) el.textContent = txt; };

    setTxt("totalConsumoDisplay", `${Math.round(base.consumoAnual)} kWh`);
    setTxt("totalImporteDisplay", `$${base.importeTotalAnual.toFixed(2)}`);
    setTxt("tarifaPromedioDisplay", `$${base.tarifaPromedio.toFixed(3)}`);

    setTxt("consumoAnual",   `${base.consumoAnual.toFixed(0)} kWh`);
    setTxt("consumoMensual", `${base.consumoMensual.toFixed(0)} kWh`);
    setTxt("consumoDiario",  `${base.consumoDiario.toFixed(1)} kWh`);

    if (hsp > 0) setTxt("hsp", `${hsp.toFixed(2)} h`);
    if (potenciaNecesaria > 0) setTxt("potenciaNecesaria", `${potenciaNecesaria.toFixed(2)} kW`);
    if (numeroModulos > 0) setTxt("numeroModulos", `${numeroModulos}`);
    if (potenciaInstalada > 0) setTxt("potenciaInstalada", `${potenciaInstalada.toFixed(2)} kW`);
    if (generacionAnual > 0) setTxt("generacionAnual", `${generacionAnual.toFixed(2)} KWh`);
    if (porcentajeAhorro > 0) setTxt("porcentajeAhorro", `${porcentajeAhorro.toFixed(1)}%`);
    if (Number.isFinite(ahorroCO2)) setTxt("ahorroCO2", `${ahorroCO2.toFixed(3)} t`);
    if (Number.isFinite(arboles)) setTxt("arboles", `${arboles.toFixed(0)} √°rboles`);

    // === Guardar en localStorage (para que PDF/PU tengan lo √∫ltimo) ===
    const resultados = {
      tipoPeriodo: base.tipoPeriodo,
      consumos: base.consumos,
      importes: base.importes,
      consumoTotal: base.consumoAnual,
      consumoAnual: base.consumoAnual,
      consumoMensual: base.consumoMensual,
      consumoDiario: base.consumoDiario,
      importeTotalAnual: base.importeTotalAnual,
      importePromedio: base.importePromedio,
      tarifas: base.tarifas,
      tarifaPromedio: base.tarifaPromedio,
      estado: estado,
      hspPromedio: hsp,
      potenciaPanel,
      potenciaNecesaria,
      numeroModulos,
      generacionAnual,
      potenciaInstalada,
      ahorroCO2,
      porcentajeAhorro: Number.isFinite(porcentajeAhorro) ? porcentajeAhorro.toFixed(1) : "0",
      selectInversor: inversorPanel || "",
      areaAprox,
      consumoAnualDeEnergia: base.consumoAnual * base.tarifaPromedio
    };
    localStorage.setItem("resultadosSistemaSolar", JSON.stringify(resultados));

    // === Disparar renders dependientes ===
    // Tu tabla P.U. ya observa 'potenciaInstalada', as√≠ que al actualizar ese texto se re-renderiza sola.
    // Si necesitas forzar, toca un campo observado:
    const potEl = $("potenciaInstalada");
    if (potEl) {
      // fuerza al MutationObserver a ver un cambio (no hace falta si ya cambi√≥ el texto)
      potEl.dataset.bump = String(Date.now());
    }
  }

  

  // === 3) ENLACES DE EVENTOS GLOBALES ===
  function wireGlobal() {
    // Elementos del dise√±o/datos que afectan KPIs
    [
      "tipoPeriodo","estadoProyecto","potenciaPanel","potenciaInversor",
      "inversorPanel","areaAprox"
    ].forEach(id => {
      const el = $(id);
      if (!el) return;
      el.addEventListener("input", schedule);
      el.addEventListener("change", schedule);
    });

    // Si regeneras inputs al cambiar per√≠odo, vuelve a cablear autocompletos
    const tipoPeriodo = $("tipoPeriodo");
    if (tipoPeriodo) {
      tipoPeriodo.addEventListener("change", () => {
        // Tu funci√≥n existente que vuelve a crear inputs:
        if (typeof generarInputsConsumo === "function") {
          generarInputsConsumo();
        }
        wireConsumptionAutoFill();
        schedule();
      });
    }

    // Al cargar, cablea consumo y hace primer rec√°lculo
    wireConsumptionAutoFill();
    schedule();
  }

  // Inicio
  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", wireGlobal);
  } else {
    wireGlobal();
  }
})();
</script>



  <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
  <div id="toast-container"></div>
</body>

</html>