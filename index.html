<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Hexa Solar - Calculadora Inteligente</title>
  <link rel="icon" type="image/png" href="logo.png">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <link rel="stylesheet" href="styles.css">
  <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>

  <!-- üîß Split bar (empieza a la mitad y permite pasarla) + consumo responsivo -->
  <style>
    /* ---------- Split layout ---------- */
    .main-container {
      display: flex;
      width: 100%;
      min-height: calc(100vh - 64px);
      overflow: hidden;
    }

    .form-panel {
      flex: 0 0 50%;
      width: 50%;
      min-width: 320px;
      overflow: auto;
    }

    .results-panel {
      flex: 1 1 auto;
      min-width: 320px;
      overflow: auto;
    }

    .resizer {
      flex: 0 0 8px;
      width: 8px;
      background: linear-gradient(90deg, #eef8f3, #d7efe3);
      box-shadow: inset 0 0 0 1px rgba(0, 0, 0, .06);
      cursor: col-resize;
      align-self: stretch;
      touch-action: none;
      position: relative;
      z-index: 10;
    }

    .resizer::after {
      content: "";
      position: absolute;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%);
      width: 3px;
      height: 44px;
      border-radius: 2px;
      background: rgba(30, 146, 75, .7);
    }

    .resizer.is-dragging {
      background: #cfeadc;
    }

    body.is-resizing {
      cursor: col-resize;
      user-select: none;
    }

    /* ---------- Consumo: inputs id√©nticos al resto y 100% responsivo ---------- */
    .consumo-panel {
      background: #fff;
      border: 1px solid #e2e8f0;
      border-radius: 12px;
      padding: 1rem 1rem 1.2rem;
    }

    .consumo-row {
      margin-top: .9rem;
    }

    .consumo-row-label {
      font-weight: 600;
      color: #2d3748;
      font-size: .95rem;
      margin-bottom: .55rem;
    }

    .consumo-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: .8rem 1rem;
    }

    @media (max-width: 1200px) {
      .consumo-grid {
        grid-template-columns: repeat(auto-fit, minmax(170px, 1fr));
      }
    }

    @media (max-width: 900px) {
      .consumo-grid {
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      }
    }

    @media (max-width: 640px) {
      .consumo-grid {
        grid-template-columns: repeat(auto-fit, minmax(130px, 1fr));
      }
    }

    .consumo-input {
      width: 100%;
      background: #fff;
      border: 1px solid #cbd5e1;
      border-radius: 8px;
      padding: 5px 7px;
      font-size: .87rem;
      color: #1a202c;
      text-align: center;
    }

    .consumo-input:focus {
      outline: none;
      border-color: #73b248;
      box-shadow: 0 0 0 3px rgba(115, 178, 72, 0.10);
    }
  </style>
</head>

<body>
  <!-- Barra superior -->
  <div class="top-bar">
    <div class="logo">
      <img src="logo.png" alt="Hexa Solar Logo" class="logo-image"
        onerror="this.style.display='none'; this.nextElementSibling.style.display='inline';">
      <i class="fas fa-solar-panel" style="display: none;"></i>
      <span>Hexa Solar Power Solution</span>
    </div>
    <div class="contact-info">
      <div class="contact-item">
        <i class="fas fa-map-marker-alt"></i>
        <span>Canc√∫n | Playa del Carmen | Tulum</span>
      </div>
      <div class="contact-item">
        <i class="fas fa-phone-alt"></i>
        <span>984 231 2287</span>
      </div>
      <div class="contact-item">
        <i class="fas fa-globe"></i>
        <a href="https://hexasolar.com.mx" class="contact-link" target="_blank">hexasolar.com.mx</a>
      </div>
    </div>
  </div>

  <!-- Contenedor principal -->
  <div class="main-container">
    <!-- Panel izquierdo - Formulario -->
    <div class="form-panel">
      <!-- Datos del Cliente -->
      <div class="form-section">
        <div class="section-title">
          <i class="fas fa-user"></i>
          <span>Datos del Cliente</span>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label for="nombreCliente">Nombre</label>
            <input type="text" id="nombreCliente" placeholder="Nombre completo"
              style="width:100%; background:#fff; border:1px solid #cbd5e1; border-radius:8px; padding:5px 7px; font-size:0.87rem; color:#1a202c;">
          </div>
          <div class="form-group">
            <label for="direccionCliente">Direcci√≥n</label>
            <input type="text" id="direccionCliente" placeholder="Calle y n√∫mero"
              style="width:100%; background:#fff; border:1px solid #cbd5e1; border-radius:8px; padding:5px 7px; font-size:0.87rem; color:#1a202c;">
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label for="estadoCliente">Estado</label>
            <select id="estadoCliente"
              style="width:100%; background:#fff; border:1px solid #cbd5e1; border-radius:8px; padding:5px 7px; font-size:0.87rem; color:#1a202c;">
              <option value="">Selecciona un estado</option>
              <option value="Aguascalientes">Aguascalientes</option>
              <option value="Baja California">Baja California</option>
              <option value="Baja California Sur">Baja California Sur</option>
              <option value="Campeche">Campeche</option>
              <option value="Chiapas">Chiapas</option>
              <option value="Chihuahua">Chihuahua</option>
              <option value="Ciudad de M√©xico">Ciudad de M√©xico</option>
              <option value="Coahuila">Coahuila</option>
              <option value="Colima">Colima</option>
              <option value="Durango">Durango</option>
              <option value="Estado de M√©xico">Estado de M√©xico</option>
              <option value="Guanajuato">Guanajuato</option>
              <option value="Guerrero">Guerrero</option>
              <option value="Hidalgo">Hidalgo</option>
              <option value="Jalisco">Jalisco</option>
              <option value="Michoac√°n">Michoac√°n</option>
              <option value="Morelos">Morelos</option>
              <option value="Nayarit">Nayarit</option>
              <option value="Nuevo Le√≥n">Nuevo Le√≥n</option>
              <option value="Oaxaca">Oaxaca</option>
              <option value="Puebla">Puebla</option>
              <option value="Quer√©taro">Quer√©taro</option>
              <option value="Quintana Roo">Quintana Roo</option>
              <option value="San Luis Potos√≠">San Luis Potos√≠</option>
              <option value="Sinaloa">Sinaloa</option>
              <option value="Sonora">Sonora</option>
              <option value="Tabasco">Tabasco</option>
              <option value="Tamaulipas">Tamaulipas</option>
              <option value="Tlaxcala">Tlaxcala</option>
              <option value="Veracruz">Veracruz</option>
              <option value="Yucat√°n">Yucat√°n</option>
              <option value="Zacatecas">Zacatecas</option>
            </select>
          </div>
          <div class="form-group">
            <label for="municipioCliente">Municipio / Ciudad</label>
            <input type="text" id="municipioCliente" placeholder="Municipio o Ciudad"
              style="width:100%; background:#fff; border:1px solid #cbd5e1; border-radius:8px; padding:5px 7px; font-size:0.87rem; color:#1a202c;">
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label for="telefonoCliente">Tel√©fono</label>
            <input type="text" id="telefonoCliente" placeholder="Tel√©fono"
              style="width:100%; background:#fff; border:1px solid #cbd5e1; border-radius:8px; padding:5px 7px; font-size:0.87rem; color:#1a202c;">
          </div>
          <div class="form-group">
            <label for="correoCliente">Correo</label>
            <input type="email" id="correoCliente" placeholder="Correo electr√≥nico"
              style="width:100%; background:#fff; border:1px solid #cbd5e1; border-radius:8px; padding:5px 7px; font-size:0.87rem; color:#1a202c;">
          </div>
        </div>
      </div>

      <!-- Datos del Ejecutivo -->
      <div class="form-section">
        <div class="section-title">
          <i class="fas fa-user-tie"></i>
          <span>Datos del Ejecutivo</span>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label for="nombreEjecutivo">Nombre del Ejecutivo</label>
            <input type="text" id="nombreEjecutivo" placeholder="Nombre del ejecutivo"
              style="width:100%; background:#fff; border:1px solid #cbd5e1; border-radius:8px; padding:5px 7px; font-size:0.87rem; color:#1a202c;">
          </div>
          <div class="form-group">
            <label for="correoEjecutivo">Correo Electr√≥nico</label>
            <input type="email" id="correoEjecutivo" placeholder="ejecutivo@empresa.com"
              style="width:100%; background:#fff; border:1px solid #cbd5e1; border-radius:8px; padding:5px 7px; font-size:0.87rem; color:#1a202c;">
          </div>
          <div class="form-group">
            <label for="folioCotizacion">Folio de Cotizaci√≥n</label>
            <input type="text" id="folioCotizacion" placeholder="Folio de cotizaci√≥n"
              style="width:100%; background:#fff; border:1px solid #cbd5e1; border-radius:8px; padding:5px 7px; font-size:0.87rem; color:#1a202c;">
          </div>
        </div>
      </div>

      <!-- Datos del Proyecto -->
      <div class="form-section">
        <div class="section-title">
          <i class="fas fa-project-diagram"></i>
          <span>Datos del Proyecto</span>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label for="tipoProyecto">Tipo de Proyecto</label>
            <select id="tipoProyecto"
              style="width:100%; background:#fff; border:1px solid #cbd5e1; border-radius:8px; padding:5px 7px; font-size:0.87rem; color:#1a202c;">
              <option value="">Seleccionar tipo</option>
              <option value="residencial">Residencial</option>
              <option value="comercial">Comercial</option>
              <option value="industrial">Industrial</option>
            </select>
          </div>
          <div class="form-group">
            <label for="tipoTarifa">Tipo de Tarifa</label>
            <select id="tipoTarifa"
              style="width:100%; background:#fff; border:1px solid #cbd5e1; border-radius:8px; padding:5px 7px; font-size:0.87rem; color:#1a202c;">
              <option value="">Selecciona una tarifa</option>
            </select>
          </div>
        </div>

        <!-- Nota + Estado -->
        <div class="form-row">
          <div class="form-group">
            <label for="notaProyecto">Nota</label>
            <input type="text" id="notaProyecto" placeholder="Nota del proyecto"
              style="width:100%; background:#fff; border:1px solid #cbd5e1; border-radius:8px; padding:5px 7px; font-size:0.87rem; color:#1a202c;">
          </div>
          <div class="form-group">
            <label for="estadoProyecto">Estado</label>
            <select id="estadoProyecto"
              style="width:100%; background:#fff; border:1px solid #cbd5e1; border-radius:8px; padding:5px 7px; font-size:0.87rem; color:#1a202c;">
              <option value="">Selecciona un estado</option>
              <option value="Aguascalientes">Aguascalientes</option>
              <option value="Baja California">Baja California</option>
              <option value="Baja California Sur">Baja California Sur</option>
              <option value="Campeche">Campeche</option>
              <option value="Chiapas">Chiapas</option>
              <option value="Chihuahua">Chihuahua</option>
              <option value="Ciudad de M√©xico">Ciudad de M√©xico</option>
              <option value="Coahuila">Coahuila</option>
              <option value="Colima">Colima</option>
              <option value="Durango">Durango</option>
              <option value="Estado de M√©xico">Estado de M√©xico</option>
              <option value="Guanajuato">Guanajuato</option>
              <option value="Guerrero">Guerrero</option>
              <option value="Hidalgo">Hidalgo</option>
              <option value="Jalisco">Jalisco</option>
              <option value="Michoac√°n">Michoac√°n</option>
              <option value="Morelos">Morelos</option>
              <option value="Nayarit">Nayarit</option>
              <option value="Nuevo Le√≥n">Nuevo Le√≥n</option>
              <option value="Oaxaca">Oaxaca</option>
              <option value="Puebla">Puebla</option>
              <option value="Quer√©taro">Quer√©taro</option>
              <option value="Quintana Roo">Quintana Roo</option>
              <option value="San Luis Potos√≠">San Luis Potos√≠</option>
              <option value="Sinaloa">Sinaloa</option>
              <option value="Sonora">Sonora</option>
              <option value="Tabasco">Tabasco</option>
              <option value="Tamaulipas">Tamaulipas</option>
              <option value="Tlaxcala">Tlaxcala</option>
              <option value="Veracruz">Veracruz</option>
              <option value="Yucat√°n">Yucat√°n</option>
              <option value="Zacatecas">Zacatecas</option>
            </select>
          </div>
        </div>

        <!-- NUEVO: Municipio/Ciudad + Regi√≥n tarifaria CFE (auto) -->
        <div class="form-row">
          <div class="form-group">
            <label for="municipioProyecto">Municipio / Ciudad</label>
            <input type="text" id="municipioProyecto" placeholder="Ciudad o Municipio"
              style="width:100%; background:#fff; border:1px solid #cbd5e1; border-radius:8px; padding:5px 7px; font-size:0.87rem; color:#1a202c;">
          </div>
          <div class="form-group">
            <label for="regionTarifariaCFE">Regi√≥n tarifaria CFE</label>
            <input type="text" id="regionTarifariaCFE" placeholder="Se llena autom√°ticamente" readonly
              style="width:100%; background:#fff; border:1px solid #cbd5e1; border-radius:8px; padding:5px 7px; font-size:0.87rem; color:#1a202c;">
          </div>
        </div>

        <div class="form-row">
          <div class="form-group" style="grid-column: span 2;">
            <label for="requerimientosProyecto">Requerimientos</label>
            <input type="text" id="requerimientosProyecto" placeholder="Requerimientos del proyecto"
              style="width:100%; background:#fff; border:1px solid #cbd5e1; border-radius:8px; padding:5px 7px; font-size:0.87rem; color:#1a202c;">
          </div>
        </div>

        <!-- Consumo -->
        <div class="section-title" style="margin-top:24px;">
          <i class="fas fa-chart-line"></i>
          <span>Datos de Consumo Energ√©tico</span>
        </div>

        <div class="form-row" style="margin-bottom: 1rem;">
          <div class="form-group">
            <label for="tipoPeriodo">Per√≠odo de Facturaci√≥n</label>
            <select id="tipoPeriodo" onchange="generarInputsConsumo()"
              style="width:100%; background:#fff; border:1px solid #cbd5e1; border-radius:8px; padding:5px 7px; font-size:0.87rem; color:#1a202c;">
              <option value="bimestral">Bimestral (6 valores)</option>
              <option value="mensual">Mensual (12 valores)</option>
            </select>
          </div>
        </div>

        <!-- Panel consumo responsivo -->
        <div id="consumoContainer" class="consumo-panel">
          <div class="form-row">
            <div class="form-group" style="grid-column: span 2;">
              <label>Consumo Hist√≥rico (kWh)</label>
              <div id="kwhRow" class="consumo-grid"></div>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group" style="grid-column: span 2;">
              <label>Pagos por Per√≠odo ($)</label>
              <div id="pagoRow" class="consumo-grid"></div>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group" style="grid-column: span 2;">
              <label>Tarifa Promedio ($/kWh)</label>
              <div id="tarifaRow" class="consumo-grid"></div>
            </div>
          </div>
        </div>
        <!-- /panel consumo -->
      </div>

      <!-- Especificaciones del panel -->
      <div class="form-section">
        <div class="section-title" style="margin-bottom:1.2rem;">
          <i class="fas fa-drafting-compass"></i>
          <span>Dise√±o y dimensionamiento</span>
        </div>

        <div class="panel-spec-grid">
          <div>
            <div class="panel-spec-row">
              <div class="form-group" style="flex:1;">
                <label for="potenciaPanel">Potencia Panel</label>
                <input value="565" type="number" id="potenciaPanel" placeholder="">
              </div>
            </div>
            <div class="panel-spec-row">
              <div class="form-group" style="flex:1;">
                <label for="marcaPanel">Marca</label>
                <input type="text" id="marcaPanel" placeholder="">
              </div>
            </div>
            <div class="panel-spec-row">
              <div class="form-group" style="flex:1;">
                <label for="modeloPanel">Modelo</label>
                <input type="text" id="modeloPanel" placeholder="">
              </div>
            </div>
            <hr class="panel-divider">
            <div class="panel-spec-row">
              <div class="form-group" style="flex:1;">
                <label for="inversorPanel">Inversor</label>
                <select id="inversorPanel"
                  style="width:100%; background:#fff; border:1px solid #cbd5e1; border-radius:8px; padding:5px 7px; font-size:0.87rem; color:#1a202c;">
                  <option value="">Seleccione</option>
                  <option value="Microinversor">Microinversor</option>
                  <option value="Central">Central</option>
                </select>
              </div>
            </div>
            <div class="panel-spec-row">
              <div class="form-group" style="flex:1;">
                <label for="potenciaInversor">Potencia</label>
                <input type="number" id="potenciaInversor" placeholder="">
              </div>
            </div>
          </div>
          <div>
            <div class="panel-spec-row">
              <div class="form-group" style="flex:1;">
                <label for="instalacionElectrica">Instalaci√≥n el√©ctrica</label>
                <select id="instalacionElectrica"
                  style="width:100%; background:#fff; border:1px solid #cbd5e1; border-radius:8px; padding:5px 7px; font-size:0.87rem; color:#1a202c;">
                  <option value="">Seleccione</option>
                  <option value="bif">Bifasica</option>
                  <option value="monof">Monofasica</option>
                  <option value="tet">Trifasica</option>
                </select>
              </div>
            </div>
            <div class="panel-spec-row">
              <div class="form-group" style="flex:1;">
                <label for="numHilos"># de hilos</label>
                <select id="numHilos"
                  style="width:100%; background:#fff; border:1px solid #cbd5e1; border-radius:8px; padding:5px 7px; font-size:0.87rem; color:#1a202c;">
                  <option value="">Seleccione</option>
                  <option value="1">1</option>
                  <option value="2">2</option>
                  <option value="3">3</option>
                  <option value="4">4</option>
                  <option value="5">5</option>
                  <option value="6">6</option>
                </select>
              </div>
            </div>
            <div class="panel-spec-row">
              <div class="form-group" style="flex:1;">
                <label for="voltajeOperacion">Voltaje oper.</label>
                <select id="voltajeOperacion"
                  style="width:100%; background:#fff; border:1px solid #cbd5e1; border-radius:8px; padding:5px 7px; font-size:0.87rem; color:#1a202c;">
                  <option value="">Seleccione</option>
                  <option value="220">220</option>
                  <option value="440">440</option>
                  <option value="480">480</option>
                </select>
              </div>
            </div>
            <hr class="panel-divider">
            <div class="panel-spec-row">
              <div class="form-group" style="flex:1;">
                <label for="areaAprox">√Årea aproximada</label>
                <input type="number" id="areaAprox" placeholder="">
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Cotizaci√≥n P.U. -->
      <div class="form-section" style="margin-top:2.2rem; margin-bottom:1.5rem;">
        <div class="section-title" style="margin-bottom:1.2rem;">
          <i class="fas fa-file-invoice-dollar"></i>
          <span>Cotizaci√≥n P.U.</span>
        </div>
        <div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:1.2rem 2.2rem; margin-bottom:1.1rem;">
          <div>
            <div class="form-group"><label for="panel" style="font-weight:500;">Panel:</label><input type="number"
                id="panel" style="width:100%;"></div>
            <div class="form-group"><label for="inversor" style="font-weight:500;">Inversor:</label><input type="number"
                id="inversor" style="width:100%;"></div>
            <div class="form-group"><label for="mantenimiento" style="font-weight:500;">Monitoreo:</label><input
                type="number" id="mantenimiento" style="width:100%;"></div>
            <div class="form-group"><label for="estructura" style="font-weight:500;">Estructura:</label><input
                type="number" id="estructura" style="width:100%;"></div>
            <div class="form-group"><label for="materiales" style="font-weight:500;">Materiales:</label><input
                type="number" id="materiales" style="width:100%;"></div>
          </div>
          <div>
            <div class="form-group"><label for="instalacion" style="font-weight:500;">Instalaci√≥n:</label><input
                type="number" id="instalacion" style="width:100%;"></div>
            <div class="form-group"><label for="carpeta" style="font-weight:500;">Carpeta de proyecto:</label><input
                type="number" id="carpeta" style="width:100%;"></div>
            <div class="form-group"><label for="flete" style="font-weight:500;">Flete:</label><input type="number"
                id="flete" style="width:100%;"></div>
            <div class="form-group"><label for="interconexion" style="font-weight:500;">Interconexi√≥n:</label><input
                type="number" id="interconexion" style="width:100%;"></div>
            <div class="form-group"><label for="uve" style="font-weight:500;">UVIE:</label><input type="number" id="uve"
                style="width:100%;"></div>
          </div>
          <div>
            <div class="form-group"><label for="uie" style="font-weight:500;">UIE:</label><input type="number" id="uie"
                style="width:100%;"></div>
            <div class="form-group"><label for="medidor" style="font-weight:500;">Medidor:</label><input type="number"
                id="medidor" style="width:100%;"></div>
            <div class="form-group"><label for="profit" style="font-weight:500;">Profit (%):</label><input type="number"
                id="profit" style="width:100%;"></div>
            <hr style="margin:1.1rem 0; border:none; border-top:1px solid #e2e8f0;">
            <div class="form-group"><label for="total" style="font-weight:500;">Total (MXN):</label><input type="text"
                id="total" style="width:100%;"></div>
          </div>
        </div>
      </div>

      <script>

        ; (() => {
          const IVA_RATE = 0.16
          const IDS_COSTOS = [
            ['panel', 'Panel'],
            ['inversor', 'Inversor'],
            ['materiales', 'Materiales'],   // <-- corregido
            ['estructura', 'Estructura'],
            ['instalacion', 'Instalaci√≥n'],
            ['carpeta', 'Carpeta (Pog)'],
            ['flete', 'Flete'],
            ['interconexion', 'Interconexi√≥n'],
            ['uve', 'UVIE'],
            ['uie', 'UIE'],
            ['medidor', 'Medidor'],
          ]

          let resultados = {}
          const data = localStorage.getItem("resultadosSistemaSolar")
          if (data) {
            resultados = JSON.parse(data)
            console.log(resultados)
          }

          // Valor declarado por ti:
          const inversorOmicro = resultados ? resultados.selectInversor : null // "Microinversor" o algo m√°s
          console.log('Inversor o micro:', inversorOmicro)
          const $ = (id) => document.getElementById(id)
          const toNumber = (v) => {
            if (v === null || v === undefined) return 0
            const s = String(v).replace(/[,$\s]/g, '').replace(',', '.')
            const n = parseFloat(s)
            return isNaN(n) ? 0 : n
          }
          const fmt = (n) => n.toLocaleString('es-MX', { style: 'currency', currency: 'MXN', maximumFractionDigits: 2 })

          const getPotenciaW = () => {
            const el = $('potenciaInstalada')
            if (!el) return null
            const kw = toNumber(el.textContent)
            return kw > 0 ? kw * 1000 : null
          }

          const getNumeroDeModulos = () => {
            // Prioriza lo calculado y guardado:
            if (resultados && Number(resultados.numeroModulos) > 0) return Number(resultados.numeroModulos)
            const el = $('numeroModulos')
            if (!el) return null
            const num = toNumber(el.textContent)
            return num > 0 ? num : null
          }

          const calcularProfit = (subtotal) => {
            const raw = $('profit')?.value
            const p = toNumber(raw)
            if (!p) return { monto: 0, etiqueta: '‚Äî' }
            if (p <= 1) return { monto: subtotal * p, etiqueta: (p * 100).toFixed(2) + '%' }
            if (p < 100) return { monto: subtotal * (p / 100), etiqueta: p.toFixed(2) + '%' }
            return { monto: p, etiqueta: fmt(p) + ' (monto)' }
          }

          const renderTabla = () => {
            const conceptos = []
            let subtotal = 0

            const numeroModulos = getNumeroDeModulos() || 1

            // ids que siempre se multiplican por N
            const idsSiemprePorModulo = new Set(['panel', 'materiales', 'estructura'])

            // si el inversor es "Microinversor", entonces tambi√©n multiplicar "inversor"
            const multiplicarInversor = (inversorOmicro && String(inversorOmicro) === 'Microinversor')

            IDS_COSTOS.forEach(([id, nombre]) => {
              let val = toNumber($(id)?.value)
              let etiqueta = nombre

              const debeMultiplicarse = idsSiemprePorModulo.has(id) || (id === 'inversor' && multiplicarInversor)

              if (debeMultiplicarse) {
                val = val * numeroModulos
                etiqueta = `${nombre} (x${numeroModulos})`
                console.log(`Multiplicando ${nombre} por ${numeroModulos}:`, etiqueta)
              }

              conceptos.push({ nombre: etiqueta, val })
              subtotal += val
            })

            const { monto: profit, etiqueta: etiquetaProfit } = calcularProfit(subtotal)
            const base = subtotal + profit
            const iva = base * IVA_RATE
            const total = base + iva

            const potenciaW = getPotenciaW()
            const pricePerWatt = potenciaW ? subtotal / potenciaW : null

            const results = $('resultsContent')
            if (!results) return
            let cont = document.getElementById('cont-desglose-cotizacion-pu')
            if (!cont) {
              cont = document.createElement('section')
              cont.id = 'cont-desglose-cotizacion-pu'
              cont.style.marginTop = '1.5rem'
              results.insertAdjacentElement('afterend', cont)
            }
            const datasistema = localStorage.getItem("resultadosSistemaSolar")
            if (datasistema) {
              const resultados = JSON.parse(datasistema)
              console.log("Resultados del sistema solar:", resultados)
            }
            let reoysinIva = base * resultados.consumoAnualDeEnergia;
            let roiConiva = total *   resultados.consumoAnualDeEnergia;
             // Guardar resultados en localStorage
        const datosParaGuardar = {
          conceptos,
          subtotal,
          profit,
          base,
          iva,
          total,
          pricePerWatt: pricePerWatt || 0,
          numeroModulos: numeroModulos,
          reoysinIva: reoysinIva || 0,
          roiConiva: roiConiva || 0
        };
        localStorage.setItem("cotizacionPU", JSON.stringify(datosParaGuardar));
        console.log("Cotizaci√≥n P.U. guardada en localStorage:", datosParaGuardar);

            const cardStyle = `
      background:#fff;border:1px solid #e2e8f0;border-radius:12px;
      padding:16px;box-shadow:0 4px 10px rgba(17,24,39,.06);overflow:auto
    `
            const titleStyle = `font-weight:600;font-size:1rem;margin:0 0 .6rem 0;display:flex;gap:.5rem;align-items:center`
            const tableStyle = `width:100%;border-collapse:collapse;font-size:.95rem`
            const thtd = `padding:.6rem .7rem;border-bottom:1px solid #edf2f7;text-align:right`
            const thLeft = `text-align:left`

            const filasConceptos = conceptos
              .filter(c => c.val && c.val !== 0)
              .map(c => `
        <tr>
          <td style="${thtd};${thLeft}">${c.nombre}</td>
          <td style="${thtd}">${fmt(c.val)}</td>
        </tr>
      `).join('')

            cont.innerHTML = `
      <div style="${cardStyle}">
        <h3 style="${titleStyle}">
          <i class="fas fa-file-invoice-dollar"></i>
          Desglose de Cotizaci√≥n P.U.
        </h3>
        <table style="${tableStyle}">
          <thead>
            <tr>
              <th style="${thtd};${thLeft}">Concepto</th>
              <th style="${thtd}">Importe</th>
            </tr>
          </thead>
          <tbody>
            ${filasConceptos || `
              <tr><td style="${thtd};${thLeft}" colspan="2">Sin datos de cotizaci√≥n a√∫n.</td></tr>
            `}
            <tr>
              <td style="${thtd};${thLeft};font-weight:600">Subtotal</td>
              <td id="subtotalDisplay" style="${thtd};font-weight:600">${fmt(subtotal)}</td>
            </tr>
            <tr>
              <td style="${thtd};${thLeft}">Profit <span style="opacity:.7">(${etiquetaProfit})</span></td>
              <td style="${thtd}">${fmt(profit)}</td>
            </tr>
            <tr>
              <td style="${thtd};${thLeft}">Base Imponible</td>
              <td style="${thtd}">${fmt(base)}</td>
            </tr>
            <tr>
              <td style="${thtd};${thLeft}">IVA (${(IVA_RATE * 100).toFixed(0)}%)</td>
              <td id="ivaDisplay" style="${thtd}">${fmt(iva)}</td>
            </tr>
            <tr>
              <td style="${thtd};${thLeft};font-weight:700">TOTAL</td>
              <td id="totalDisplay" style="${thtd};font-weight:700">${fmt(total)}</td>
            </tr>
            ${pricePerWatt !== null ? `
              <tr>
                <td style="${thtd};${thLeft}">$/Watt (sin IVA)</td>
                <td style="${thtd}">${pricePerWatt.toLocaleString('es-MX', { maximumFractionDigits: 2 })}</td>
              </tr>
              <tr>
                <td style="${thtd};${thLeft}">$/Watt (con IVA)</td>
                <td style="${thtd}">${(pricePerWatt * (1 + IVA_RATE)).toLocaleString('es-MX', { maximumFractionDigits: 2 })}</td>
              </tr>
            ` : ``}
          </tbody>
        </table>
        <div style="margin-top:.6rem;font-size:.85rem;color:#64748b">
          * La fila <em>$/Watt</em> aparece cuando la tarjeta <strong>Potencia Instalada (kW)</strong> ya tiene valor.
        </div>
      </div>
    `
          }

          const attach = () => {
            const ids = IDS_COSTOS.map(([id]) => id).concat(['profit'])
            ids.forEach(id => {
              const el = $(id)
              if (el) el.addEventListener('input', renderTabla)
            })
            const pot = $('potenciaInstalada')
            if (pot) {
              const mo = new MutationObserver(renderTabla)
              mo.observe(pot, { childList: true, characterData: true, subtree: true })
            }
            renderTabla()
          }

          if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', attach)
          } else {
            attach()
          }
        })()

       


      </script>

      <script>
        (() => {
          // Campos que S√ç se suman (profit NO est√° aqu√≠)
          const IDS_SUM = [
            "panel", "inversor", "mantenimiento", "estructura", "materiales",
            "instalacion", "carpeta", "flete", "interconexion", "uve", "uie", "medidor"
          ];

          const $ = id => document.getElementById(id);

          const toNumber = v => {
            if (v == null) return 0;
            const s = String(v).replace(/[^\d.-]/g, "");
            const n = parseFloat(s);
            return isNaN(n) ? 0 : n;
          };

          const formatOut = (n, out) =>
            (out?.type === "number")
              ? Number(n).toFixed(2)
              : Number(n).toLocaleString("es-MX", { minimumFractionDigits: 2, maximumFractionDigits: 2 });

          function calcularTotal() {
            let total = 0;
            IDS_SUM.forEach(id => { total += toNumber($(id)?.value); });

            // NO sumar profit. Solo lo leemos para disparar rec√°lculo si cambia.
            const out = $("total");
            if (out) out.value = formatOut(total, out);
          }

          function attach() {
            // Escucha todos los permitidos‚Ä¶
            IDS_SUM.forEach(id => { const el = $(id); if (el) el.addEventListener("input", calcularTotal); });
            // ‚Ä¶y tambi√©n profit para que al cambiarlo NO sume pero s√≠ se recalculen otros efectos si tuvieses.
            const profit = $("profit");
            if (profit) profit.addEventListener("input", calcularTotal);

            calcularTotal();
          }

          document.readyState === "loading"
            ? document.addEventListener("DOMContentLoaded", attach)
            : attach();
        })();
      </script>




      <button class="calculate-btn" id="btnNuevoCalculo" onclick="nuevoCalculo()">
        <i class="fas fa-redo"></i>
        <span>Nuevo C√°lculo</span>
      </button>
      <!-- Bot√≥n de c√°lculo -->
      <button class="calculate-btn" id="btnCalcular" onclick="if(validarFormulario()) calcularSistemaSolar()">
        <i class="fas fa-calculator"></i>
        <span>Calcular Sistema Solar</span>
      </button>

    </div>


    <script>
      function nuevoCalculo() {
        // Borrar del localStorage
        localStorage.removeItem("resultadosSistemaSolar");
        console.log("Resultados eliminados del localStorage");

        // Reactivar bot√≥n calcular
        document.getElementById("btnCalcular").disabled = false;

        // Limpiar resultados en pantalla (opcional)
        document.getElementById("resultsContent").style.display = "none";
        document.getElementById("resultsPlaceholder").style.display = "flex";

        // Tambi√©n podr√≠as limpiar inputs si quieres:
        const inputs = document.querySelectorAll("input.consumo-input");
        inputs.forEach(input => input.value = "");
      }
    </script>



    <!-- üî∏ Barra que permite redimensionar -->
    <div class="resizer" id="splitter" aria-label="Arrastra para ajustar"></div>

    <!-- Panel derecho - Resultados -->
    <div class="results-panel">
      <!-- Estado inicial -->
      <div class="results-placeholder" id="resultsPlaceholder">
        <img src="logo.png" alt="Hexa Solar Logo" style="height:64px; margin-bottom:12px; opacity:0.5;">
        <h3>An√°lisis Solar Inteligente</h3>
        <p>Complete los datos del formulario y presione "Calcular Sistema Solar" para ver los resultados detallados</p>
      </div>

      <!-- Contenido de resultados -->
      <div class="results-content" id="resultsContent">
        <div class="results-header">
          <div class="results-title">An√°lisis Completado</div>
          <div class="results-subtitle">Sistema Solar Fotovoltaico Optimizado</div>
        </div>

        <div class="metrics-grid">
          <div class="metric-card">
            <div class="metric-icon"><i class="fas fa-bolt"></i></div>
            <div class="metric-value" id="consumoAnual">-</div>
            <div class="metric-label">Consumo Anual (kWh)</div>
          </div>
          <div class="metric-card">
            <div class="metric-icon"><i class="fas fa-calendar-day"></i></div>
            <div class="metric-value" id="consumoMensual">-</div>
            <div class="metric-label">Consumo Mensual Promedio</div>
          </div>
          <div class="metric-card">
            <div class="metric-icon"><i class="fas fa-sun"></i></div>
            <div class="metric-value" id="consumoDiario">-</div>
            <div class="metric-label">Consumo Diario Promedio</div>
          </div>
          <div class="metric-card">
            <div class="metric-icon"><i class="fas fa-dollar-sign"></i></div>
            <div class="metric-value" id="importeTotal">-</div>
            <div class="metric-label">Importe de CFE Total Anual</div>
          </div>
          <div class="metric-card">
            <div class="metric-icon"><i class="fas fa-coins"></i></div>
            <div class="metric-value" id="importePromedio">-</div>
            <div class="metric-label">Importe Promedio</div>
          </div>
          <div class="metric-card">
            <div class="metric-icon"><i class="fas fa-calculator"></i></div>
            <div class="metric-value" id="tarifaPromedio">-</div>
            <div class="metric-label">Tarifa Promedio ($/kWh)</div>
          </div>
          <div class="metric-card">
            <div class="metric-icon"><i class="fas fa-percentage"></i></div>
            <div class="metric-value" id="porcentajeAhorro">-</div>
            <div class="metric-label">% de Ahorro</div>
          </div>
          <!-- <div class="metric-card">
              <div class="metric-icon"><i class="fas fa-thermometer-half"></i></div>
              <div class="metric-value" id="tempMin">-</div>
              <div class="metric-label">Temp Min (¬∞C)</div>
            </div> -->
          <!-- <div class="metric-card">
              <div class="metric-icon"><i class="fas fa-thermometer-full"></i></div>
              <div class="metric-value" id="tempMax">-</div>
              <div class="metric-label">Temp Max (¬∞C)</div>
            </div> -->
          <div class="metric-card">
            <div class="metric-icon"><i class="fas fa-plug"></i></div>
            <div class="metric-value" id="potenciaNecesaria">-</div>
            <div class="metric-label">Potencia Necesaria (kW)</div>
          </div>
          <div class="metric-card">
            <div class="metric-icon"><i class="fas fa-solar-panel"></i></div>
            <div class="metric-value" id="numeroModulos">-</div>
            <div class="metric-label">M√≥dulos Requeridos</div>
          </div>
          <!-- <div class="metric-card">
              <div class="metric-icon"><i class="fas fa-industry"></i></div>
              <div class="metric-value" id="generacionAnual">-</div>
              <div class="metric-label">Generaci√≥n Anual (kWh)</div>
            </div> -->
          <div class="metric-card">
            <div class="metric-icon"><i class="fas fa-expand-arrows-alt"></i></div>
            <div class="metric-value" id="potenciaInstalada">-</div>
            <div class="metric-label">Potencia Instalada (kW)</div>
          </div>
          <div class="metric-card">
            <div class="metric-icon"><i class="fas fa-sun"></i></div>
            <div class="metric-value" id="hsp">-</div>
            <div class="metric-label">Horas Solares Pico</div>
          </div>
          <div class="metric-card">
            <div class="metric-icon"><i class="fas fa-leaf"></i></div>
            <div class="metric-value" id="ahorroCO2">-</div>
            <div class="metric-label">Ahorro CO‚ÇÇ (t/a√±o)</div>
          </div>
          <div class="metric-card">
            <div class="metric-icon"><i class="fas fa-tree"></i></div>
            <div class="metric-value" id="arboles">-</div>
            <div class="metric-label">√Årboles Equivalentes</div>
          </div>
          <div class="metric-card">
            <div class="metric-icon"><i class="fas fa-bolt"></i></div>
            <div class="metric-value" id="arboles">-</div>
            <div class="metric-label">Generaci√≥n anual aproximada</div>
          </div>
          <div class="metric-card">
            <div class="metric-icon"><i class="fas fa-percentage"></i></div>
            <div class="metric-value" id="arboles">-</div>
            <div class="metric-label">Porcentaje de generaci√≥n</div>
          </div>
          <div class="metric-card">
            <div class="metric-icon"><i class="fas fa-arrow-rotate-left"></i></div>
            <div class="metric-value" id="arboles">-</div>
            <div class="metric-label">ROI</div>
          </div>
        </div>

        <div class="chart-section">
          <div class="chart-header"><i class="fas fa-chart-bar"></i> Gr√°fica de Irradiaci√≥n Solar</div>
          <div class="chart-container"><canvas id="irradiacionChart" width="800" height="400"></canvas></div>
        </div>

        <div class="details-table">
          <div class="table-header"><i class="fas fa-table"></i> An√°lisis Detallado por Per√≠odo</div>
          <div class="table-content">
            <div class="table-row" style="font-weight: 600; background: rgba(16, 185, 129, 0.1);">
              <div class="table-cell">Per√≠odo</div>
              <div class="table-cell">Consumo (kWh)</div>
              <div class="table-cell">Importe ($)</div>
              <div class="table-cell">Tarifa ($/kWh)</div>
            </div>
            <div id="detalleTableBody"></div>
          </div>
        </div>

        <!-- <div class="chart-section">
          <div class="chart-header"><i class="fas fa-chart-bar"></i> Impacto de la Generaci√≥n vs Consumo</div>
          <div class="chart-container"><canvas id="impactoChart" width="800" height="400"></canvas></div>
        </div> -->

        <div id="impactoWrapper" style="width:100%;max-width:900px">
          <canvas id="impactoChart" style="width:100%;height:320px;"></canvas>
        </div>




        <button class="calculate-btn" onclick="exportToBasePdf()">
          <i class="fas fa-file-contract"></i>
          <span>Generar Cotizaci√≥n</span>
        </button>
      </div>
    </div>
  </div>

  <!-- Loading overlay -->
  <div class="loading-overlay" id="loading">
    <div class="loading-content">
      <div class="loading-spinner"><i class="fas fa-solar-panel fa-spin"></i></div>
      <div class="loading-text">Procesando Datos</div>
      <div class="loading-subtext">Consultando irradiaci√≥n solar...</div>
    </div>
  </div>

  <script src="script.js"></script>
  <script src="scriptpdf.js"></script>

  <!-- JS de la barra resizable -->
  <script>
    (function () {
      const container = document.querySelector('.main-container');
      const left = document.querySelector('.form-panel');
      const resizer = document.getElementById('splitter');
      if (!container || !left || !resizer) return;

      const MIN_LEFT = 320;   // px
      const MIN_RIGHT = 320;  // px

      let startX = 0, startW = 0, dragging = false;

      function clampLeftWidth(px) {
        const total = container.getBoundingClientRect().width;
        const maxByRight = total - MIN_RIGHT;
        return Math.max(MIN_LEFT, Math.min(maxByRight, px));
      }
      function setLeftWidth(px) {
        const w = clampLeftWidth(px);
        left.style.width = w + 'px';
        left.style.flex = `0 0 ${w}px`;
      }
      function setHalf() {
        const total = container.getBoundingClientRect().width;
        setLeftWidth(total / 2);
      }
      function onPointerDown(e) {
        dragging = true;
        startX = (e.touches ? e.touches[0].clientX : e.clientX);
        startW = left.getBoundingClientRect().width;
        document.body.classList.add('is-resizing');
        resizer.classList.add('is-dragging');

        window.addEventListener('pointermove', onPointerMove);
        window.addEventListener('pointerup', onPointerUp);
        window.addEventListener('touchmove', onTouchMove, { passive: false });
        window.addEventListener('touchend', onPointerUp);
        window.addEventListener('mousemove', onMouseMove);
        window.addEventListener('mouseup', onPointerUp);
      }
      function onPointerMove(e) { if (!dragging) return; const dx = e.clientX - startX; setLeftWidth(startW + dx); }
      function onMouseMove(e) { if (!dragging) return; const dx = e.clientX - startX; setLeftWidth(startW + dx); }
      function onTouchMove(e) { if (!dragging) return; e.preventDefault(); const dx = e.touches[0].clientX - startX; setLeftWidth(startW + dx); }
      function onPointerUp() {
        dragging = false;
        document.body.classList.remove('is-resizing');
        resizer.classList.remove('is-dragging');
        window.removeEventListener('pointermove', onPointerMove);
        window.removeEventListener('pointerup', onPointerUp);
        window.removeEventListener('touchmove', onTouchMove);
        window.removeEventListener('touchend', onPointerUp);
        window.removeEventListener('mousemove', onMouseMove);
        window.removeEventListener('mouseup', onPointerUp);
      }
      resizer.addEventListener('pointerdown', onPointerDown);
      resizer.addEventListener('mousedown', onPointerDown);
      resizer.addEventListener('touchstart', onPointerDown, { passive: true });
      window.addEventListener('load', setHalf);
      window.addEventListener('resize', setHalf);
      setTimeout(setHalf, 0);
    })();
  </script>

  <!-- JS para el panel de Consumo -->
  <script>

    //no borrar esta funcion, esta es la funcion que genera los inputs de consumo
    function generarInputsConsumo() {
      const select = document.getElementById('tipoPeriodo');
      const n = (select && select.value === 'mensual') ? 12 : 6;

      const kwhRow = document.getElementById('kwhRow');
      const pagoRow = document.getElementById('pagoRow');
      const tarifaRow = document.getElementById('tarifaRow');
      if (!kwhRow || !pagoRow || !tarifaRow) return;

      kwhRow.innerHTML = '';
      pagoRow.innerHTML = '';
      tarifaRow.innerHTML = '';

      // Periodos seg√∫n tipo
      const periodosMensuales = [
        "Ene", "Feb", "Mar", "Abr", "May", "Jun",
        "Jul", "Ago", "Sep", "Oct", "Nov", "Dic"
      ];
      const periodosBimestrales = [
        "Bim 1", "Bim 2", "Bim 3",
        "Bim 4", "Bim 5", "Bim 6"
      ];

      const periodos = (n === 12) ? periodosMensuales : periodosBimestrales;

      const toNum = (v) => {
        if (v === null || v === undefined) return NaN;
        const s = String(v).trim().replace(',', '.');
        const x = parseFloat(s);
        return Number.isFinite(x) ? x : NaN;
      };
      const hasNum = (v) => !Number.isNaN(toNum(v));
      const fix2 = (x) => (Math.round((x + Number.EPSILON) * 100) / 100).toFixed(2);

      const recalcular = (i, source) => {
        const k = document.getElementById(`consumo${i}`);
        const p = document.getElementById(`importe${i}`);
        const t = document.getElementById(`tarifa${i}`);

        const consumo = toNum(k.value);
        const importe = toNum(p.value);
        const tarifa = toNum(t.value);

        if (source === 'importe') {
          if (hasNum(consumo) && consumo > 0 && hasNum(importe)) {
            t.value = fix2(importe / consumo);
          }
          return;
        }

        if (source === 'tarifa') {
          if (hasNum(consumo) && consumo > 0 && hasNum(tarifa)) {
            p.value = fix2(tarifa * consumo);
          }
          return;
        }

        if (source === 'consumo') {
          if (hasNum(consumo) && consumo > 0) {
            if (hasNum(importe) && importe > 0) {
              t.value = fix2(importe / consumo);
            } else if (!hasNum(importe) || importe === 0) {
              if (hasNum(tarifa) && tarifa > 0) {
                p.value = fix2(tarifa * consumo);
              }
            }
          }
          return;
        }
      };

      for (let i = 1; i <= n; i++) {
        const periodo = periodos[i - 1] || `Periodo ${i}`;

        // Etiqueta
        const label = document.createElement('div');
        label.textContent = periodo;
        label.style.fontSize = "12px";
        label.style.fontWeight = "normal";
        label.style.color = "#6c757d";
        label.style.textAlign = "center";
        label.style.marginBottom = "2px";

        // Contenedor vertical
        const contK = document.createElement('div');
        contK.style.display = "flex";
        contK.style.flexDirection = "column";
        contK.style.alignItems = "center";
        contK.style.margin = "0 5px";

        const contP = contK.cloneNode(false);
        const contT = contK.cloneNode(false);

        // Consumo (kWh)
        const k = document.createElement('input');
        k.type = 'number';
        k.step = 'any';
        k.inputMode = 'decimal';
        k.className = 'consumo-input';
        k.id = `consumo${i}`;
        k.addEventListener('input', () => recalcular(i, 'consumo'));
        contK.appendChild(label.cloneNode(true));
        contK.appendChild(k);

        // Importe ($)
        const p = document.createElement('input');
        p.type = 'number';
        p.step = 'any';
        p.inputMode = 'decimal';
        p.className = 'consumo-input';
        p.id = `importe${i}`;
        p.addEventListener('input', () => recalcular(i, 'importe'));
        contP.appendChild(label.cloneNode(true));
        contP.appendChild(p);

        // Tarifa ($/kWh)
        const t = document.createElement('input');
        t.type = 'number';
        t.step = 'any';
        t.inputMode = 'decimal';
        t.className = 'consumo-input';
        t.id = `tarifa${i}`;
        t.addEventListener('input', () => recalcular(i, 'tarifa'));
        contT.appendChild(label.cloneNode(true));
        contT.appendChild(t);

        kwhRow.appendChild(contK);
        pagoRow.appendChild(contP);
        tarifaRow.appendChild(contT);
      }
    }

    function generarInputsConsumo() {
      const select = document.getElementById('tipoPeriodo');
      const n = (select && select.value === 'mensual') ? 12 : 6;

      const kwhRow = document.getElementById('kwhRow');
      const pagoRow = document.getElementById('pagoRow');
      const tarifaRow = document.getElementById('tarifaRow');
      if (!kwhRow || !pagoRow || !tarifaRow) return;

      // Limpiar contenedores (evita duplicados)
      kwhRow.innerHTML = '';
      pagoRow.innerHTML = '';
      tarifaRow.innerHTML = '';

      // Periodos seg√∫n tipo
      const periodosMensuales = ["Ene", "Feb", "Mar", "Abr", "May", "Jun", "Jul", "Ago", "Sep", "Oct", "Nov", "Dic"];
      const periodosBimestrales = ["Bim 1", "Bim 2", "Bim 3", "Bim 4", "Bim 5", "Bim 6"];
      const periodos = (n === 12) ? periodosMensuales : periodosBimestrales;

      // === DATOS DE PRUEBA ===
      const samples = {
        bimestral: {
          // Tus datos reales de ejemplo
          consumo: [690, 631, 422, 970, 1011, 752],
          importe: [1695, 1685, 489, 2798, 2998, 2269],
          tarifa: [] // vac√≠o: se calcula con importe/consumo
        },
        mensual: {
          // Ejemplo gen√©rico (aj√∫stalo a lo que quieras ver por defecto)
          consumo: [400, 380, 420, 500, 520, 480, 510, 500, 450, 430, 390, 370],
          importe: [1200, 1140, 1260, 1500, 1560, 1440, 1530, 1500, 1350, 1290, 1170, 1110],
          tarifa: [] // vac√≠o: se calcula con importe/consumo
        }
      };

      const datosPrueba = (n === 12) ? samples.mensual : samples.bimestral;

      // Helpers
      const toNum = (v) => {
        if (v === null || v === undefined) return NaN;
        const s = String(v).trim().replace(',', '.');
        const x = parseFloat(s);
        return Number.isFinite(x) ? x : NaN;
      };
      const hasNum = (v) => !Number.isNaN(toNum(v));
      const fix2 = (x) => (Math.round((x + Number.EPSILON) * 100) / 100).toFixed(2);

      const recalcular = (i, source) => {
        const k = document.getElementById(`consumo${i}`);
        const p = document.getElementById(`importe${i}`);
        const t = document.getElementById(`tarifa${i}`);

        const consumo = toNum(k.value);
        const importe = toNum(p.value);
        const tarifa = toNum(t.value);

        if (source === 'importe') {
          if (hasNum(consumo) && consumo > 0 && hasNum(importe)) t.value = fix2(importe / consumo);
          return;
        }
        if (source === 'tarifa') {
          if (hasNum(consumo) && consumo > 0 && hasNum(tarifa)) p.value = fix2(tarifa * consumo);
          return;
        }
        if (source === 'consumo') {
          if (hasNum(consumo) && consumo > 0) {
            if (hasNum(importe) && importe > 0) {
              t.value = fix2(importe / consumo);
            } else if ((!hasNum(importe) || importe === 0) && hasNum(tarifa) && tarifa > 0) {
              p.value = fix2(tarifa * consumo);
            }
          }
          return;
        }
      };

      // Construcci√≥n de inputs
      for (let i = 1; i <= n; i++) {
        const periodo = periodos[i - 1] || `Periodo ${i}`;

        // Etiqueta
        const label = document.createElement('div');
        label.textContent = periodo;
        label.style.fontSize = "12px";
        label.style.fontWeight = "normal";
        label.style.color = "#6c757d";
        label.style.textAlign = "center";
        label.style.marginBottom = "2px";

        // Contenedores
        const baseCol = () => {
          const d = document.createElement('div');
          d.style.display = "flex";
          d.style.flexDirection = "column";
          d.style.alignItems = "center";
          d.style.margin = "0 5px";
          return d;
        };
        const contK = baseCol();
        const contP = baseCol();
        const contT = baseCol();

        // Consumo (kWh)
        const k = document.createElement('input');
        k.type = 'number'; k.step = 'any'; k.inputMode = 'decimal';
        k.className = 'consumo-input'; k.id = `consumo${i}`;
        k.addEventListener('input', () => recalcular(i, 'consumo'));
        contK.appendChild(label.cloneNode(true));
        contK.appendChild(k);

        // Importe ($)
        const p = document.createElement('input');
        p.type = 'number'; p.step = 'any'; p.inputMode = 'decimal';
        p.className = 'consumo-input'; p.id = `importe${i}`;
        p.addEventListener('input', () => recalcular(i, 'importe'));
        contP.appendChild(label.cloneNode(true));
        contP.appendChild(p);

        // Tarifa ($/kWh)
        const t = document.createElement('input');
        t.type = 'number'; t.step = 'any'; t.inputMode = 'decimal';
        t.className = 'consumo-input'; t.id = `tarifa${i}`;
        t.addEventListener('input', () => recalcular(i, 'tarifa'));
        contT.appendChild(label.cloneNode(true));
        contT.appendChild(t);

        kwhRow.appendChild(contK);
        pagoRow.appendChild(contP);
        tarifaRow.appendChild(contT);
      }

      // === Cargar datos de prueba y autocalcular lo faltante ===
      for (let i = 1; i <= n; i++) {
        const k = document.getElementById(`consumo${i}`);
        const p = document.getElementById(`importe${i}`);
        const t = document.getElementById(`tarifa${i}`);

        const cVal = datosPrueba.consumo[i - 1];
        const mVal = datosPrueba.importe[i - 1];
        const rVal = datosPrueba.tarifa[i - 1];

        if (typeof cVal !== 'undefined') k.value = cVal;
        if (typeof mVal !== 'undefined') p.value = mVal;
        if (typeof rVal !== 'undefined') t.value = rVal;

        // Si no hay tarifa pero s√≠ consumo+importe, calc√∫lala
        const c = toNum(k.value);
        const m = toNum(p.value);
        const r = toNum(t.value);

        if ((!hasNum(r) || r === 0) && hasNum(c) && c > 0 && hasNum(m) && m > 0) {
          t.value = fix2(m / c);
        } else if ((!hasNum(m) || m === 0) && hasNum(c) && c > 0 && hasNum(r) && r > 0) {
          // Alternativa: si viene tarifa y consumo pero no importe, calc√∫lalo
          p.value = fix2(c * r);
        }
      }
    }

    window.addEventListener('load', generarInputsConsumo);
    document.getElementById('tipoPeriodo')?.addEventListener('change', generarInputsConsumo);

    //valores de preuba, quitar en produccion

    // function generarInputsConsumo() {
    //   const select = document.getElementById('tipoPeriodo');
    //   const n = (select && select.value === 'mensual') ? 12 : 6;

    //   const kwhRow = document.getElementById('kwhRow');
    //   const pagoRow = document.getElementById('pagoRow');
    //   const tarifaRow = document.getElementById('tarifaRow');
    //   if (!kwhRow || !pagoRow || !tarifaRow) return;

    //   kwhRow.innerHTML = '';
    //   pagoRow.innerHTML = '';
    //   tarifaRow.innerHTML = '';

    //   // Valores por defecto (kWh, Importe)
    //   const valores = [
    //     [690.00, 1695.00],
    //     [631.00, 1685.00],
    //     [422.00, 489.00],
    //     [970.00, 2798.00],
    //     [1011.00, 2998.00],
    //     [752.00, 2269.00]
    //   ];

    //   const toNum = (v) => {
    //     const x = parseFloat(v);
    //     return Number.isFinite(x) ? x : 0;
    //   };

    //   const fix2 = (x) => (Math.round((x + Number.EPSILON) * 100) / 100).toFixed(2);

    //   // Reglas:
    //   // - Si importe > 0 => tarifa = importe/consumo (si consumo > 0)
    //   // - Si importe == 0 o vac√≠o y tarifa > 0 => importe = tarifa*consumo
    //   // - Si ambos vac√≠os/0 => ambos 0
    //   const recalcular = (i) => {
    //     const k = document.getElementById(`consumo${i}`);
    //     const p = document.getElementById(`importe${i}`);
    //     const t = document.getElementById(`tarifa${i}`);

    //     const consumo = toNum(k.value);
    //     let importe = toNum(p.value);
    //     let tarifa = toNum(t.value);

    //     if (importe > 0) {
    //       // Usuario ingres√≥ (o hay) importe
    //       if (consumo > 0) {
    //         tarifa = importe / consumo;
    //         t.value = fix2(tarifa);
    //       } else {
    //         // Consumo 0 => tarifa 0 porque no se puede dividir
    //         t.value = '0.00';
    //       }
    //     } else {
    //       // No hay importe => si hay tarifa, calcular importe
    //       if (tarifa > 0 && consumo > 0) {
    //         importe = tarifa * consumo;
    //         p.value = fix2(importe);
    //       } else {
    //         // No hay informaci√≥n suficiente
    //         p.value = '0.00';
    //         t.value = '0.00';
    //       }
    //     }
    //   };

    //   for (let i = 1; i <= n; i++) {
    //     // Consumo (kWh)
    //     const k = document.createElement('input');
    //     k.type = 'number';
    //     k.step = '0.01';
    //     k.className = 'consumo-input';
    //     k.id = `consumo${i}`;
    //     k.value = valores[i - 1] ? valores[i - 1][0] : 0;
    //     k.addEventListener('input', () => recalcular(i));
    //     kwhRow.appendChild(k);

    //     // Importe ($)
    //     const p = document.createElement('input');
    //     p.type = 'number';
    //     p.step = '0.01';
    //     p.className = 'consumo-input';
    //     p.id = `importe${i}`;
    //     p.placeholder = '0.00'; // Si lo dejan vac√≠o/0, se calcular√° desde tarifa
    //     p.value = valores[i - 1] ? valores[i - 1][1] : 0;
    //     p.addEventListener('input', () => recalcular(i));
    //     pagoRow.appendChild(p);

    //     // Tarifa ($/kWh)
    //     const t = document.createElement('input');
    //     t.type = 'number';
    //     t.step = '0.01';
    //     t.className = 'tarifa-input';
    //     t.id = `tarifa${i}`;
    //     t.placeholder = '0.00'; // Si hay tarifa y no hay importe, calcular√° el importe
    //     t.addEventListener('input', () => recalcular(i));
    //     tarifaRow.appendChild(t);

    //     // Inicial: si hay importe y consumo, calcular tarifa; si no, dejar 0
    //     const consumoInit = toNum(k.value);
    //     const importeInit = toNum(p.value);
    //     if (importeInit > 0 && consumoInit > 0) {
    //       t.value = fix2(importeInit / consumoInit);
    //     } else {
    //       t.value = '0.00';
    //     }
    //   }
    // }

    // window.addEventListener('load', generarInputsConsumo);
    // document.getElementById('tipoPeriodo')?.addEventListener('change', generarInputsConsumo);
  </script>

  <!-- JS: Regi√≥n tarifaria CFE autom√°tica seg√∫n estado -->
  <script>
    (function () {
      const estadoProyecto = document.getElementById('estadoProyecto');
      const regionInput = document.getElementById('regionTarifariaCFE');

      const regiones = {
        "Regi√≥n Norte": ["Chihuahua", "Coahuila", "Nuevo Le√≥n", "Durango"],
        "Regi√≥n Noreste": ["San Luis Potos√≠", "Tamaulipas"],
        "Regi√≥n Noroeste": ["Sonora", "Sinaloa"],
        "Regi√≥n Baja California": ["Baja California"],
        "Regi√≥n Baja California Sur": ["Baja California Sur"],
        "Regi√≥n Peninsular": ["Yucat√°n", "Campeche", "Quintana Roo"],
        "Regi√≥n Central": ["Ciudad de M√©xico", "Estado de M√©xico", "Morelos", "Tlaxcala", "Puebla", "Hidalgo"],
        "Regi√≥n Sur": ["Zacatecas", "Michoac√°n", "Guerrero", "Oaxaca", "Chiapas", "Veracruz", "Tabasco", "Aguascalientes", "Colima", "Guanajuato", "Jalisco", "Nayarit", "Quer√©taro"]
      };

      function obtenerRegion(estado) {
        for (const [region, lista] of Object.entries(regiones)) {
          if (lista.includes(estado)) return region;
        }
        return "";
      }

      function actualizarRegion() {
        const estadoSel = estadoProyecto ? estadoProyecto.value : "";
        if (regionInput) {
          regionInput.value = obtenerRegion(estadoSel);
        }
      }

      if (estadoProyecto) {
        estadoProyecto.addEventListener('change', actualizarRegion);
        window.addEventListener('load', actualizarRegion);
      }
    })();
  </script>
  <script>
    (function () {
      // Cambia la tasa si lo necesitas (16% en MX)
      const IVA_RATE = 0.16;

      // IDs de TODAS las partidas que suman al subtotal
      const PARTIDAS = [
        "panel", "inversor", "mantenimiento", "estructura", "materiales",
        "instalacion", "carpeta", "flete", "interconexion", "uve",
        "uie", "medidor", "profit", "watts"
      ];

      const $subtotal = document.getElementById("subtotal");
      const $iva = document.getElementById("iva");
      const $total = document.getElementById("total");

      // Asegura que Subtotal / IVA / Total no sean editables
      [$subtotal, $iva, $total].forEach(el => {
        if (el) {
          el.readOnly = true;
          el.style.background = "#f8fafc"; // opcional, para verse "deshabilitado"
        }
      });

      const toNumber = (v) => {
        const n = parseFloat(String(v).replace(/,/g, ""));
        return isNaN(n) ? 0 : n;
      };

      function recalc() {
        let subtotal = 0;
        PARTIDAS.forEach(id => {
          const el = document.getElementById(id);
          if (el) subtotal += toNumber(el.value);
        });

        const iva = subtotal * IVA_RATE;
        const total = subtotal + iva;

        if ($subtotal) $subtotal.value = subtotal.toFixed(2);
        if ($iva) $iva.value = iva.toFixed(2);
        if ($total) $total.value = total.toFixed(2);
      }

      // Recalcular cuando se cambie cualquier partida
      PARTIDAS.forEach(id => {
        const el = document.getElementById(id);
        if (el) el.addEventListener("input", recalc);
      });

      // Calcular al cargar
      window.addEventListener("load", recalc);
    })();
  </script>

  <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
  <script>
    function validarFormulario() {
      // üîπ Todos los IDs de tu formulario
      const obligatorios = [
        // Cliente
        // "nombreCliente","direccionCliente","estadoCliente","municipioCliente","telefonoCliente","correoCliente",
        // // Ejecutivo
        // "nombreEjecutivo","correoEjecutivo","folioCotizacion",
        // // Proyecto
        // "tipoProyecto","tipoTarifa","estadoProyecto","municipioProyecto",
        // // Dise√±o y dimensionamiento
        // "potenciaPanel","marcaPanel","modeloPanel","inversorPanel",
        // "areaAprox",
        // // Cotizaci√≥n P.U.
        // "panel","inversor","mantenimiento","estructura","materiales",
        // "instalacion","carpeta","flete","interconexion","uve","uie","medidor","profit"
      ];

      let valido = true;

      obligatorios.forEach(id => {
        const el = document.getElementById(id);
        if (!el) return;

        // ‚ö†Ô∏è Condici√≥n corregida: obligatorio pero se acepta "0"
        if (el.value === null || el.value.trim() === "") {
          valido = false;
          el.style.borderColor = "red";

          Toastify({
            text: `El campo "${id}" es obligatorio`,
            duration: 3000,
            gravity: "top",
            position: "right",
            backgroundColor: "linear-gradient(to right, #ef4444, #dc2626)",
            stopOnFocus: true
          }).showToast();

        } else {
          el.style.borderColor = "#cbd5e1";
        }
      });

      // üîπ Validaci√≥n especial: Microinversor ‚Üí requiere inversor lleno (pero puede ser "0")
      const inversorTipo = document.getElementById("inversorPanel").value;
      const inversorVal = document.getElementById("inversor").value;
      if (inversorTipo === "Microinversor" && (!inversorVal || inversorVal.trim() === "")) {
        valido = false;
        document.getElementById("inversor").style.borderColor = "red";

        Toastify({
          text: "Si el inversor es Microinversor, debes ingresar el costo del Inversor (aunque sea 0)",
          duration: 4000,
          gravity: "top",
          position: "right",
          backgroundColor: "linear-gradient(to right, #f97316, #ea580c)",
          stopOnFocus: true
        }).showToast();
      }

      return valido;
    }
  </script>


  <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
</body>

</html>